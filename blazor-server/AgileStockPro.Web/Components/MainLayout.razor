@inherits LayoutComponentBase

<PageTitle>AgileStockPro</PageTitle>

@using Microsoft.FluentUI.AspNetCore.Components
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons
@using Microsoft.AspNetCore.WebUtilities

@inject AgileStockPro.Web.Services.IAuthService Auth
@inject AgileStockPro.Web.Services.Api.ITokenProvider Tokens
@inject IToastService Toast
@inject NavigationManager Navigation
@inject AgileStockPro.Web.Services.IUserStore UserStore

@{
    var relative = Navigation.ToBaseRelativePath(Navigation.Uri) ?? string.Empty;
    var relLower = relative.ToLowerInvariant();
    // Si la ruta contiene 'login' asumimos que es la pantalla de autenticación
    bool isAuthPage = !string.IsNullOrEmpty(relLower) && relLower.Contains("login");
    bool showShell = !isAuthPage;
}

<div class="layout-root">
    @if (showShell)
    {
        <header class="site-header">
            <button class="btn" title="Contraer/Expandir menú" @onclick="ToggleSidebar">≡</button>
            <input class="search" placeholder="Buscar..." />
            <div style="margin-left:auto; display:flex; gap:.5rem; align-items:center;">
                @if (currentUser is not null)
                {
                    <div class="user-area" style="display:flex; gap:.5rem; align-items:center;">
                        <a href="/profile" class="user-badge btn" title="Mi Perfil" style="text-decoration:none; display:flex; align-items:center; gap:5px;">
                            <FluentIcon Icon="@(Icons.Regular.Size16.Person)" />
                            <span class="username">@currentUser.Username</span>
                        </a>
                        <button class="btn" @onclick="Logout">Salir</button>
                    </div>
                }
                else
                {
                    <a class="btn" href="/login">Ingresar</a>
                }
            </div>
        </header>
    }

    @if (showShell)
    {
        <div class="layout-body @(collapsed ? "collapsed" : null)">
            <AgileStockPro.Web.Components.NavMenu Collapsed="collapsed" User="currentUser" />
            <main class="content">
                <CascadingValue Value="Toast">
                    @Body
                </CascadingValue>
            </main>
        </div>
    }
    else
    {
        <main class="content login-only">
            <CascadingValue Value="Toast">
                @Body
            </CascadingValue>
        </main>
    }

    <FluentToastProvider />
    <FluentDialogProvider />
    <FluentTooltipProvider />
    <FluentMessageBarProvider />
    <FluentMenuProvider />
</div>

@code {
    private bool collapsed;
    private AgileStockPro.Web.Models.AppUser? currentUser;
    private System.Timers.Timer? _logoutTimer;

    protected override async Task OnInitializedAsync()
    {
        currentUser = await Auth.GetCurrentUserAsync();
        SetupAutoLogout();
        // Check security questions enforcement
        await CheckSecurityRequirements();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Re-check on navigation if needed, but OnInitialized is usually enough for layout unless user changes.
        // However, if user navigates, layout might not re-initialize if it's the same layout.
        // But Blazor Server re-renders layout on navigation? No, it stays.
        // So we should hook into navigation events or check here.
        // Let's rely on OnInitialized for now, but if we want strict enforcement on every page load:
        // We can't easily do async work in OnParametersSet without careful state management.
        // But we can check currentUser state.
    }

    private async Task CheckSecurityRequirements()
    {
        if (currentUser == null) return;

        var relative = Navigation.ToBaseRelativePath(Navigation.Uri) ?? string.Empty;
        var relLower = relative.ToLowerInvariant();

        // Allow access to config page, logout, and static assets (if any)
        if (relLower.StartsWith("configurar-seguridad") || relLower.StartsWith("logout") || relLower.StartsWith("login"))
        {
            return;
        }

        try
        {
            // Check if user has security questions configured.
            // We might need to fetch this from UserStore if not in currentUser object.
            // currentUser.SecurityQuestions might be empty if not loaded.
            // Let's assume we need to check via API or Store.
            // But wait, currentUser is loaded from Auth.GetCurrentUserAsync().
            // Does that include SecurityQuestions?
            // If not, we might need to call an endpoint.
            // Let's check if we can get the policy status.
            
            // Optimization: Only check if we suspect they aren't set.
            // Or just check every time?
            // Let's try to get the user's security questions status.
            // Since we don't have a direct "HasSecurityQuestions" property on AppUser that is guaranteed populated,
            // we might need to fetch it.
            // However, to avoid performance hit on every layout load, maybe we can store a flag in session/claim?
            // For now, let's fetch it.
            
            var questions = await UserStore.GetSecurityQuestionsAsync(currentUser.Username);
            if (questions == null || !questions.Any())
            {
                // No questions configured!
                // Redirect to configuration page
                Navigation.NavigateTo("/configurar-seguridad");
                Toast.ShowWarning("Debes configurar tus preguntas de seguridad para continuar.");
            }
        }
        catch { /* Ignore errors here to avoid blocking app if API fails, or log them */ }

        EnforcePasswordChange();
    }

    private void ToggleSidebar() => collapsed = !collapsed;
    private async Task Logout()
    {
        await Auth.LogoutAsync();
        currentUser = null;
        Toast.ShowInfo("Sesión cerrada");
        Navigation.NavigateTo("/login", true);
    }

    private void SetupAutoLogout()
    {
        try
        {
            _logoutTimer?.Stop();
            _logoutTimer?.Dispose();
            var token = Tokens.Token;
            if (string.IsNullOrWhiteSpace(token)) return;
            var exp = GetJwtExpiryUtc(token);
            if (exp == null) return;
            var now = DateTimeOffset.UtcNow;
            var ms = (exp.Value - now).TotalMilliseconds;
            if (ms <= 0) { _ = Logout(); return; }
            _logoutTimer = new System.Timers.Timer(ms);
            _logoutTimer.AutoReset = false;
            _logoutTimer.Elapsed += async (_, __) => { await Logout(); };
            _logoutTimer.Start();
        }
        catch { }
    }

    private void EnforcePasswordChange()
    {
        try
        {
            if (currentUser?.MustChangePassword == true)
            {
                var relative = Navigation.ToBaseRelativePath(Navigation.Uri) ?? string.Empty;
                if (!relative.StartsWith("change-password", StringComparison.OrdinalIgnoreCase))
                {
                    Navigation.NavigateTo("/change-password", true);
                }
            }
        }
        catch { }
    }

    private static DateTimeOffset? GetJwtExpiryUtc(string jwt)
    {
        try
        {
            var parts = jwt.Split('.');
            if (parts.Length < 2) return null;
            var payload = parts[1];
            payload = PadBase64(payload);
            var json = System.Text.Json.JsonDocument.Parse(Convert.FromBase64String(payload));
            if (json.RootElement.TryGetProperty("exp", out var exp) && exp.TryGetInt64(out var seconds))
            {
                return DateTimeOffset.FromUnixTimeSeconds(seconds);
            }
        }
        catch { }
        return null;
    }

    private static string PadBase64(string s)
    {
        s = s.Replace('-', '+').Replace('_', '/');
        return s.PadRight(s.Length + (4 - s.Length % 4) % 4, '=');
    }
}
