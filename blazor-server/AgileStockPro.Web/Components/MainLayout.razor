@inherits LayoutComponentBase

<PageTitle>AgileStockPro</PageTitle>

@using Microsoft.FluentUI.AspNetCore.Components

@inject AgileStockPro.Web.Services.IAuthService Auth

<div class="layout-root">
    <header class="site-header">
        <button class="btn" title="Contraer/Expandir menú" @onclick="ToggleSidebar">≡</button>
        <div class="brand">AgileStockPro</div>
        <input class="search" placeholder="Buscar..." />
        <div style="margin-left:auto; display:flex; gap:.5rem; align-items:center;">
            @if (currentUser is not null)
            {
                <span class="muted">@currentUser.Username (@(currentUser.IsAdmin ? "Admin" : "Usuario"))</span>
                <a class="btn" href="/change-password">Cambiar contraseña</a>
                <button class="btn" @onclick="Logout">Salir</button>
            }
            else
            {
                <a class="btn" href="/login">Ingresar</a>
            }
        </div>
    </header>
    <div class="layout-body @(collapsed ? "collapsed" : null)">
        <AgileStockPro.Web.Components.NavMenu Collapsed="collapsed" User="currentUser" />
        <main class="content">
            @Body
        </main>
    </div>
        <FluentToastProvider />
        <FluentDialogProvider />
        <FluentTooltipProvider />
        <FluentMessageBarProvider />
        <FluentMenuProvider />
</div>

@code {
    private bool collapsed;
    private AgileStockPro.Web.Models.AppUser? currentUser;

    protected override async Task OnInitializedAsync()
    {
        currentUser = await Auth.GetCurrentUserAsync();
    }

    private void ToggleSidebar() => collapsed = !collapsed;
    private async Task Logout()
    {
        await Auth.LogoutAsync();
        currentUser = null;
        StateHasChanged();
    }
}
