@page "/ventas"
@using BusinessLogic.Services
@using Contracts
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject ISalesService SalesService
@inject IDialogService DialogService
@inject AgileStockPro.Web.Services.IAuthService AuthService
@inject NavigationManager Nav

<PageTitle>Ventas</PageTitle>

<div style="padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Ventas</h1>
        @if (currentUser?.IsAdmin == true)
        {
            <FluentButton Appearance="Appearance.Accent" OnClick="@CreateSale">Nueva Venta</FluentButton>
        }
    </div>

    <div style="margin-bottom: 20px;">
        <FluentDatePicker @bind-Value="startDate" Label="Desde" />
        <FluentDatePicker @bind-Value="endDate" Label="Hasta" />
        <FluentButton OnClick="@LoadData">Filtrar</FluentButton>
    </div>

    @if (sales == null)
    {
        <FluentProgressRing />
    }
    else
    {
        <FluentDataGrid Items="@sales.AsQueryable()" ResizableColumns="true" GridTemplateColumns="0.5fr 1fr 1fr 1fr 1fr 1fr">
            <PropertyColumn Property="@(p => p.Id)" Sortable="true" Title="#" />
            <PropertyColumn Property="@(p => p.Cliente)" Sortable="true" />
            <PropertyColumn Property="@(p => p.Fecha)" Format="dd/MM/yyyy" Sortable="true" />
            <PropertyColumn Property="@(p => p.TipoDocumento)" Sortable="true" />
            <PropertyColumn Property="@(p => p.Total)" Format="C2" Sortable="true" />
            <PropertyColumn Property="@(p => p.Estado)" Sortable="true" />
        </FluentDataGrid>
    }
</div>

@code {
    private IEnumerable<SaleOrderDto>? sales;
    private DateTime? startDate = DateTime.Today.AddDays(-30);
    private DateTime? endDate = DateTime.Today;

    private AgileStockPro.Web.Models.AppUser? currentUser;
    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthService.GetCurrentUserAsync();
        await LoadData();
    }

    private async Task LoadData()
    {
        sales = await SalesService.GetSalesAsync(startDate, endDate, null);
    }

    private void CreateSale()
    {
        Nav.NavigateTo("/ventas/nueva");
    }
}
