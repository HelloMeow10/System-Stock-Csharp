@page "/ventas"
@using BusinessLogic.Services
@using Contracts
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject ISalesService SalesService
@inject IDialogService DialogService
@inject AgileStockPro.Web.Services.IAuthService AuthService
@inject NavigationManager Nav
@inject Microsoft.JSInterop.IJSRuntime JS

<PageTitle>Ventas</PageTitle>

<div class="page-ventas">
    <div class="header-row">
        <h1>Ventas</h1>
        @if (currentUser?.IsAdmin == true)
        {
            <FluentButton Appearance="Appearance.Accent" OnClick="@CreateSale">Nueva Venta</FluentButton>
        }
    </div>

    <div class="filters">
        <FluentDatePicker @bind-Value="startDate" Label="Desde" />
        <FluentDatePicker @bind-Value="endDate" Label="Hasta" />
        <FluentButton OnClick="@LoadData">Filtrar</FluentButton>
    </div>

    @if (sales == null)
    {
        <FluentProgressRing />
    }
    else
    {
        <FluentDataGrid Items="@sales.AsQueryable()" ResizableColumns="true" GridTemplateColumns="0.5fr 1fr 1fr 1fr 1fr 1fr">
            <PropertyColumn Property="@(p => p.Id)" Sortable="true" Title="#" />
            <PropertyColumn Property="@(p => p.Cliente)" Sortable="true" />
            <PropertyColumn Property="@(p => p.Fecha)" Format="dd/MM/yyyy" Sortable="true" />
            <PropertyColumn Property="@(p => p.TipoDocumento)" Sortable="true" />
            <PropertyColumn Property="@(p => p.Total)" Format="C2" Sortable="true" />
            <PropertyColumn Property="@(p => p.Estado)" Sortable="true" />
        </FluentDataGrid>
    }
</div>

@code {
    private IEnumerable<SaleOrderDto>? sales;
    private DateTime? startDate = DateTime.Today.AddDays(-30);
    private DateTime? endDate = DateTime.Today;

    private AgileStockPro.Web.Models.AppUser? currentUser;
    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthService.GetCurrentUserAsync();
        await LoadData();
    }

    private IJSObjectReference? _ventasShadowModule;
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _ventasShadowModule = await JS.InvokeAsync<Microsoft.JSInterop.IJSObjectReference>("import", "/js/shadow-styles.js");
                await _ventasShadowModule.InvokeVoidAsync("applyVentasShadowStyles");
            }
            catch { /* ignore failures â€” non-critical */ }
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_ventasShadowModule != null)
        {
            try { await _ventasShadowModule.DisposeAsync(); } catch { }
        }
    }

    private async Task LoadData()
    {
        sales = await SalesService.GetSalesAsync(startDate, endDate, null);
    }

    private void CreateSale()
    {
        Nav.NavigateTo("/ventas/nueva");
    }
}
