@page "/ventas"
@using BusinessLogic.Services
@using Contracts
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject ISalesService SalesService
@inject IDialogService DialogService
@inject AgileStockPro.Web.Services.IAuthService AuthService
@inject NavigationManager Nav
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@* JS ya no se requiere: removemos Fluent/shadow-root *@

<PageTitle>Ventas</PageTitle>

<div class="page-ventas">
    <div class="header-row">
        <h1>Ventas</h1>
        @if (currentUser?.IsAdmin == true)
        {
            <button class="btn btn-primary" @onclick="CreateSale">Nueva Venta</button>
        }
    </div>

    <div class="filters">
        <label for="desde">Desde</label>
        <InputDate TValue="DateTime?" @bind-Value="startDate" class="input" id="desde" />
        <label for="hasta">Hasta</label>
        <InputDate TValue="DateTime?" @bind-Value="endDate" class="input" id="hasta" />
        <button class="btn" @onclick="LoadData">Filtrar</button>
    </div>

    @if (sales == null)
    {
        <div class="loading-inline" aria-live="polite">Cargandoâ€¦</div>
    }
    else
    {
        <div class="data-grid">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Cliente</th>
                        <th>Fecha</th>
                        <th>Tipo Documento</th>
                        <th>Total</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var p in sales)
                {
                    <tr>
                        <td>@p.Id</td>
                        <td>@p.Cliente</td>
                        <td>@p.Fecha.ToString("dd/MM/yyyy")</td>
                        <td>@p.TipoDocumento</td>
                        <td>@p.Total.ToString("C2")</td>
                        <td>@p.Estado</td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private IEnumerable<SaleOrderDto>? sales;
    private DateTime? startDate = DateTime.Today.AddDays(-30);
    private DateTime? endDate = DateTime.Today;
    

    private AgileStockPro.Web.Models.AppUser? currentUser;
    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthService.GetCurrentUserAsync();
        await LoadData();
    }

    private async Task LoadData()
    {
        sales = await SalesService.GetSalesAsync(startDate, endDate, null);
    }

    private void CreateSale()
    {
        Nav.NavigateTo("/ventas/nueva");
    }
}
