@page "/facturacion"
@using BusinessLogic.Services
@using Contracts
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@inject IInvoicingService InvoicingService
@inject ISupplierService SupplierService
@inject IClientService ClientService
@inject IProductCatalogService ProductService
@inject IToastService Toast

<PageTitle>Facturación</PageTitle>

<div style="padding: 20px; max-width: 1200px; margin: 0 auto;">
    <h1>Facturación</h1>

    <div style="display:flex; gap:.5rem; margin:10px 0 20px;">
        <button class="btn @(activeTabId=="ventas"?"btn-primary":"")" @onclick="@(() => SetTab("ventas"))">Ventas</button>
        <button class="btn @(activeTabId=="compras"?"btn-primary":"")" @onclick="@(() => SetTab("compras"))">Compras</button>
    </div>

    @if (activeTabId == "ventas")
    {
        <div style="margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3>Facturas de Venta</h3>
                <button class="btn btn-primary" @onclick="ShowSalesForm">Nueva Factura Venta</button>
            </div>
            <div style="margin-bottom: 16px; display: flex; gap: 10px; align-items: flex-end; flex-wrap:wrap;">
                <div style="display:flex; flex-direction:column; gap:4px;">
                    <label>Desde</label>
                    <input type="date" class="input input-short" value="@salesFrom?.ToString("yyyy-MM-dd")" @onchange="OnSalesFromChanged" />
                </div>
                <div style="display:flex; flex-direction:column; gap:4px;">
                    <label>Hasta</label>
                    <input type="date" class="input input-short" value="@salesTo?.ToString("yyyy-MM-dd")" @onchange="OnSalesToChanged" />
                </div>
                <button class="btn" @onclick="LoadSalesInvoices">Filtrar</button>
            </div>
            @if (isLoadingSales)
            {
                <div class="loading" style="padding:.75rem; font-size:.9rem; opacity:.8;">Cargando facturas de venta...</div>
            }
            else if (salesInvoices == null || !salesInvoices.Any())
            {
                <p>No hay facturas de venta en el rango seleccionado.</p>
            }
            else
            {
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Número</th>
                            <th>Cliente</th>
                            <th>Total</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in salesInvoices)
                        {
                            <tr>
                                <td>@p.Id</td>
                                <td>@p.Fecha.ToString("dd/MM/yyyy")</td>
                                <td>@p.TipoDocumento</td>
                                <td>@p.Numero</td>
                                <td>@p.EntidadNombre</td>
                                <td>@p.Total.ToString("C2")</td>
                                <td>@p.Estado</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    }
    else if (activeTabId == "compras")
    {
        <div style="margin-top: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3>Facturas de Compra</h3>
                <button class="btn btn-primary" @onclick="ShowPurchaseForm">Registrar Factura Compra</button>
            </div>
            <div style="margin-bottom: 16px; display: flex; gap: 10px; align-items: flex-end; flex-wrap:wrap;">
                <div style="display:flex; flex-direction:column; gap:4px;">
                    <label>Desde</label>
                    <input type="date" class="input input-short" value="@purchaseFrom?.ToString("yyyy-MM-dd")" @onchange="OnPurchaseFromChanged" />
                </div>
                <div style="display:flex; flex-direction:column; gap:4px;">
                    <label>Hasta</label>
                    <input type="date" class="input input-short" value="@purchaseTo?.ToString("yyyy-MM-dd")" @onchange="OnPurchaseToChanged" />
                </div>
                <button class="btn" @onclick="LoadPurchaseInvoices">Filtrar</button>
            </div>
            @if (isLoadingPurchases)
            {
                <div class="loading" style="padding:.75rem; font-size:.9rem; opacity:.8;">Cargando facturas de compra...</div>
            }
            else if (purchaseInvoices == null || !purchaseInvoices.Any())
            {
                <p>No hay facturas de compra en el rango seleccionado.</p>
            }
            else
            {
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Fecha</th>
                            <th>Número</th>
                            <th>Proveedor</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in purchaseInvoices)
                        {
                            <tr>
                                <td>@p.Id</td>
                                <td>@p.Fecha.ToString("dd/MM/yyyy")</td>
                                <td>@p.Numero</td>
                                <td>@p.EntidadNombre</td>
                                <td>@p.Total.ToString("C2")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>
    }
</div>

@* Modal for Sales Invoice *@
@if (showSalesForm)
{
    <div class="modal-backdrop">
        <div class="modal-content">
            <h3 style="margin-top:0;">Nueva Factura de Venta</h3>
            <div class="form-group">
                <label>Cliente</label>
                <select class="input" @bind="salesForm.ClienteIdStr">
                    <option value="">Seleccione Cliente...</option>
                    @foreach (var c in customers)
                    {
                        <option value="@c.Id">@c.Nombre</option>
                    }
                </select>
            </div>
            <div class="form-group">
                <label>Tipo Documento</label>
                <select class="input" @bind="salesForm.TipoDocumento">
                    @foreach(var t in docTypes){<option value="@t">@t</option>}
                </select>
            </div>
            <div class="form-group">
                <label>Fecha</label>
                <input type="date" class="input" value="@salesForm.Fecha?.ToString("yyyy-MM-dd")" @onchange="OnSalesFormDateChanged" />
            </div>

            <h4 style="margin-bottom:8px;">Items</h4>
            <div class="items-grid">
                <select class="input" @bind="newItem.ProductIdStr">
                    <option value="">Producto...</option>
                    @foreach(var p in products){<option value="@p.Id">@p.Codigo - @p.Nombre</option>}
                </select>
                <input class="input" type="number" min="1" @bind="newItem.Cantidad" />
                <input class="input" type="number" step="0.01" @bind="newItem.Precio" />
                <button class="btn" @onclick="AddSalesItem">Agregar</button>
            </div>
            <div style="margin-top:10px; max-height:200px; overflow-y:auto; border:1px solid var(--stroke-color); border-radius:8px;">
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="background:var(--neutral-layer-2);">
                            <th style="padding:6px 8px; text-align:left;">Producto</th>
                            <th style="padding:6px 8px; text-align:left;">Cant</th>
                            <th style="padding:6px 8px; text-align:left;">Precio</th>
                            <th style="padding:6px 8px; text-align:left;">Subtotal</th>
                            <th style="padding:6px 8px; text-align:left;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach(var it in salesForm.Items)
                        {
                            <tr>
                                <td style="padding:6px 8px;">@it.Descripcion</td>
                                <td style="padding:6px 8px;">@it.Cantidad</td>
                                <td style="padding:6px 8px;">@it.PrecioUnitario.ToString("C2")</td>
                                <td style="padding:6px 8px;">@( (it.Cantidad * it.PrecioUnitario).ToString("C2") )</td>
                                <td style="padding:6px 8px;">
                                    <button class="btn" @onclick="() => salesForm.Items.Remove(it)">Eliminar</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div style="text-align: right; margin-top: 10px; font-weight: bold;">
                Total: @salesForm.Items.Sum(x => x.Cantidad * x.PrecioUnitario).ToString("C2")
            </div>
            <div class="modal-actions" style="display:flex; justify-content:flex-end; gap:.5rem; margin-top:10px;">
                <button class="btn" @onclick="() => showSalesForm = false" disabled="@isSubmitting">Cancelar</button>
                <button class="btn btn-primary" @onclick="SubmitSalesInvoice" disabled="@isSubmitting">@(isSubmitting?"Guardando...":"Guardar")</button>
            </div>
        </div>
    </div>
}

@* Modal for Purchase Invoice *@
@if (showPurchaseForm)
{
    <div class="modal-backdrop">
        <div class="modal-content">
            <h3 style="margin-top:0;">Registrar Factura de Compra</h3>
            <div class="form-group">
                <label>Proveedor</label>
                <select class="input" @bind="purchaseForm.ProveedorIdStr">
                    <option value="">Seleccione Proveedor...</option>
                    @foreach (var s in suppliers)
                    {
                        <option value="@s.Id">@s.Nombre</option>
                    }
                </select>
            </div>
            <div class="form-group">
                <label>Número Factura</label>
                <input class="input" @bind="purchaseForm.Numero" />
            </div>
            <div class="form-group">
                <label>Fecha</label>
                <input type="date" class="input" value="@purchaseForm.Fecha?.ToString("yyyy-MM-dd")" @onchange="OnPurchaseFormDateChanged" />
            </div>

            <h4 style="margin-bottom:8px;">Items</h4>
            <div class="items-grid">
                <select class="input" @bind="newItem.ProductIdStr">
                    <option value="">Producto...</option>
                    @foreach(var p in products){<option value="@p.Id">@p.Codigo - @p.Nombre</option>}
                </select>
                <input class="input" type="number" min="1" @bind="newItem.Cantidad" />
                <input class="input" type="number" step="0.01" @bind="newItem.Precio" />
                <button class="btn" @onclick="AddPurchaseItem">Agregar</button>
            </div>
            <div style="margin-top:10px; max-height:200px; overflow-y:auto; border:1px solid var(--stroke-color); border-radius:8px;">
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="background:var(--neutral-layer-2);">
                            <th style="padding:6px 8px; text-align:left;">Producto</th>
                            <th style="padding:6px 8px; text-align:left;">Cant</th>
                            <th style="padding:6px 8px; text-align:left;">Precio</th>
                            <th style="padding:6px 8px; text-align:left;">Subtotal</th>
                            <th style="padding:6px 8px; text-align:left;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach(var it in purchaseForm.Items)
                        {
                            <tr>
                                <td style="padding:6px 8px;">@it.Descripcion</td>
                                <td style="padding:6px 8px;">@it.Cantidad</td>
                                <td style="padding:6px 8px;">@it.PrecioUnitario.ToString("C2")</td>
                                <td style="padding:6px 8px;">@( (it.Cantidad * it.PrecioUnitario).ToString("C2") )</td>
                                <td style="padding:6px 8px;">
                                    <button class="btn" @onclick="() => purchaseForm.Items.Remove(it)">Eliminar</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div style="text-align: right; margin-top: 10px; font-weight: bold;">
                Total: @purchaseForm.Items.Sum(x => x.Cantidad * x.PrecioUnitario).ToString("C2")
            </div>
            <div class="modal-actions" style="display:flex; justify-content:flex-end; gap:.5rem; margin-top:10px;">
                <button class="btn" @onclick="() => showPurchaseForm = false" disabled="@isSubmitting">Cancelar</button>
                <button class="btn btn-primary" @onclick="SubmitPurchaseInvoice" disabled="@isSubmitting">@(isSubmitting?"Guardando...":"Guardar")</button>
            </div>
        </div>
    </div>
}

<style>
    .modal-backdrop { position: fixed; inset:0; background: rgba(0,0,0,0.55); display:flex; justify-content:center; align-items:flex-start; padding-top:4vh; z-index:1000; }
    .modal-content { background: var(--neutral-layer-1); color: var(--neutral-foreground-rest); padding:20px 22px; border-radius:12px; width:640px; max-width:92%; max-height:90vh; overflow-y:auto; border:1px solid var(--container-border); box-shadow:0 40px 100px rgba(2,6,23,0.55); }
    .form-group { margin-bottom:14px; display:flex; flex-direction:column; gap:4px; }
    .items-grid { display:grid; grid-template-columns: 2.2fr 0.8fr 1fr auto; gap:10px; align-items:start; }
    @@media (max-width:680px){ .items-grid { grid-template-columns: 1fr 1fr 1fr auto; } }
</style>

@code {
    string activeTabId = "ventas";
    bool isLoadingSales;
    bool isLoadingPurchases;
    bool isSubmitting;
    bool showSalesForm;
    bool showPurchaseForm;

    IEnumerable<InvoiceDto>? salesInvoices;
    IEnumerable<InvoiceDto>? purchaseInvoices;

    // Filters
    DateTime? salesFrom = DateTime.Today.AddDays(-30);
    DateTime? salesTo = DateTime.Today;
    DateTime? purchaseFrom = DateTime.Today.AddDays(-30);
    DateTime? purchaseTo = DateTime.Today;

    // Lists
    List<ClientDto> customers = new();
    List<SupplierDto> suppliers = new();
    List<ProductDto> products = new();
    List<string> docTypes = new() { "Factura", "NotaCredito", "NotaDebito" };

    // Forms
    SalesFormModel salesForm = new();
    PurchaseFormModel purchaseForm = new();
    ItemModel newItem = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadSalesInvoices();
    }

    void SetTab(string id)
    {
        activeTabId = id;
        if (activeTabId == "compras" && purchaseInvoices == null)
        {
            _ = LoadPurchaseInvoices();
        }
    }

    async Task LoadSalesInvoices()
    {
        isLoadingSales = true;
        try { salesInvoices = await InvoicingService.GetSalesInvoicesAsync(salesFrom, salesTo, null); }
        catch (Exception ex) { Toast.ShowError(ex.Message); }
        finally { isLoadingSales = false; }
    }

    async Task LoadPurchaseInvoices()
    {
        isLoadingPurchases = true;
        try { purchaseInvoices = await InvoicingService.GetPurchaseInvoicesAsync(purchaseFrom, purchaseTo, null); }
        catch (Exception ex) { Toast.ShowError(ex.Message); }
        finally { isLoadingPurchases = false; }
    }

    async Task ShowSalesForm()
    {
        if (customers.Count == 0)
        {
            customers = (await ClientService.GetAllAsync()).ToList();
            var p = await ProductService.GetProductsAsync(null, 1, 1000);
            products = p.Items.ToList();
        }
        salesForm = new();
        newItem = new();
        showSalesForm = true;
    }

    async Task ShowPurchaseForm()
    {
        if (suppliers.Count == 0)
        {
            suppliers = (await SupplierService.GetAllAsync()).ToList();
            var p = await ProductService.GetProductsAsync(null, 1, 1000);
            products = p.Items.ToList();
        }
        purchaseForm = new();
        newItem = new();
        showPurchaseForm = true;
    }

    void AddSalesItem()
    {
        if (string.IsNullOrEmpty(newItem.ProductIdStr) || newItem.Cantidad <= 0) return;
        var prod = products.FirstOrDefault(p => p.Id.ToString() == newItem.ProductIdStr);
        if (prod == null) return;

        salesForm.Items.Add(new InvoiceDetailRequest
        {
            ProductoId = prod.Id,
            Descripcion = prod.Nombre,
            Cantidad = newItem.Cantidad,
            PrecioUnitario = newItem.Precio > 0 ? newItem.Precio : prod.Precio // Use input price or default
        });
        newItem = new();
    }

    void AddPurchaseItem()
    {
        if (string.IsNullOrEmpty(newItem.ProductIdStr) || newItem.Cantidad <= 0) return;
        var prod = products.FirstOrDefault(p => p.Id.ToString() == newItem.ProductIdStr);
        if (prod == null) return;

        purchaseForm.Items.Add(new InvoiceDetailRequest
        {
            ProductoId = prod.Id,
            Descripcion = prod.Nombre,
            Cantidad = newItem.Cantidad,
            PrecioUnitario = newItem.Precio // Must be entered for purchases
        });
        newItem = new();
    }

    async Task SubmitSalesInvoice()
    {
        if (string.IsNullOrEmpty(salesForm.ClienteIdStr) || !salesForm.Items.Any())
        {
            Toast.ShowError("Complete cliente e items.");
            return;
        }
        isSubmitting = true;
        try
        {
            var req = new CreateSalesInvoiceRequest
            {
                ClienteId = int.Parse(salesForm.ClienteIdStr),
                TipoDocumento = salesForm.TipoDocumento,
                Fecha = salesForm.Fecha ?? DateTime.Now,
                Items = salesForm.Items
            };
            await InvoicingService.CreateSalesInvoiceAsync(req);
            Toast.ShowSuccess("Factura creada.");
            showSalesForm = false;
            await LoadSalesInvoices();
        }
        catch (Exception ex) { Toast.ShowError(ex.Message); }
        finally { isSubmitting = false; }
    }

    async Task SubmitPurchaseInvoice()
    {
        if (string.IsNullOrEmpty(purchaseForm.ProveedorIdStr) || !purchaseForm.Items.Any() || string.IsNullOrEmpty(purchaseForm.Numero))
        {
            Toast.ShowError("Complete proveedor, número e items.");
            return;
        }
        isSubmitting = true;
        try
        {
            var req = new CreatePurchaseInvoiceRequest
            {
                ProveedorId = int.Parse(purchaseForm.ProveedorIdStr),
                Numero = purchaseForm.Numero,
                Fecha = purchaseForm.Fecha ?? DateTime.Now,
                Items = purchaseForm.Items
            };
            await InvoicingService.CreatePurchaseInvoiceAsync(req);
            Toast.ShowSuccess("Factura registrada.");
            showPurchaseForm = false;
            await LoadPurchaseInvoices();
        }
        catch (Exception ex) { Toast.ShowError(ex.Message); }
        finally { isSubmitting = false; }
    }

    class SalesFormModel
    {
        public string? ClienteIdStr { get; set; }
        public string TipoDocumento { get; set; } = "Factura";
        public DateTime? Fecha { get; set; } = DateTime.Now;
        public List<InvoiceDetailRequest> Items { get; set; } = new();
    }

    class PurchaseFormModel
    {
        public string? ProveedorIdStr { get; set; }
        public string Numero { get; set; } = string.Empty;
        public DateTime? Fecha { get; set; } = DateTime.Now;
        public List<InvoiceDetailRequest> Items { get; set; } = new();
    }

    class ItemModel
    {
        public string? ProductIdStr { get; set; }
        public int Cantidad { get; set; } = 1;
        public decimal Precio { get; set; }
    }

    void OnSalesFromChanged(ChangeEventArgs e) { if (DateTime.TryParse(e.Value?.ToString(), out var d)) salesFrom = d; }
    void OnSalesToChanged(ChangeEventArgs e) { if (DateTime.TryParse(e.Value?.ToString(), out var d)) salesTo = d; }
    void OnPurchaseFromChanged(ChangeEventArgs e) { if (DateTime.TryParse(e.Value?.ToString(), out var d)) purchaseFrom = d; }
    void OnPurchaseToChanged(ChangeEventArgs e) { if (DateTime.TryParse(e.Value?.ToString(), out var d)) purchaseTo = d; }
    void OnSalesFormDateChanged(ChangeEventArgs e) { if (DateTime.TryParse(e.Value?.ToString(), out var d)) salesForm.Fecha = d; }
    void OnPurchaseFormDateChanged(ChangeEventArgs e) { if (DateTime.TryParse(e.Value?.ToString(), out var d)) purchaseForm.Fecha = d; }
}
