@page "/proveedores"
@using BusinessLogic.Services
@using Contracts
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject ISupplierService SupplierService
@inject IDialogService DialogService

<PageTitle>Proveedores</PageTitle>

<div style="padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Proveedores</h1>
        <FluentButton Appearance="Appearance.Accent" OnClick="@AddSupplier">Nuevo Proveedor</FluentButton>
    </div>

    <FluentTextField @bind-Value="searchTerm" Placeholder="Buscar por nombre o CUIT..." Style="width: 300px; margin-bottom: 20px;" @oninput="@(e => Search(e.Value?.ToString()))" />

    @if (suppliers == null)
    {
        <FluentProgressRing />
    }
    else
    {
        <FluentDataGrid Items="@suppliers.AsQueryable()" ResizableColumns="true" GridTemplateColumns="0.5fr 1fr 1fr 1fr 1fr 0.5fr 0.5fr 1fr">
            <PropertyColumn Property="@(p => p.Id)" Sortable="true" />
            <PropertyColumn Property="@(p => p.Codigo)" Sortable="true" Title="Código" />
            <PropertyColumn Property="@(p => p.Nombre)" Sortable="true" />
            <PropertyColumn Property="@(p => p.RazonSocial)" Sortable="true" Title="Razón Social" />
            <PropertyColumn Property="@(p => p.Cuit)" Sortable="true" Title="CUIT" />
            <PropertyColumn Property="@(p => p.TiempoEntrega)" Sortable="true" Title="Entrega (días)" />
            <PropertyColumn Property="@(p => p.Descuento)" Sortable="true" Title="Descuento %" />
            <TemplateColumn Title="Acciones">
                <FluentButton IconEnd="@(new Icons.Regular.Size16.Edit())" OnClick="@(() => Edit(context))" Appearance="Appearance.Lightweight" />
                <FluentButton IconEnd="@(new Icons.Regular.Size16.Delete())" OnClick="@(() => Delete(context))" Appearance="Appearance.Lightweight" />
            </TemplateColumn>
        </FluentDataGrid>
    }
</div>

@code {
    private IEnumerable<SupplierDto>? suppliers;
    private string searchTerm = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        suppliers = await SupplierService.GetAllAsync();
    }

    private async Task Search(string? term)
    {
        searchTerm = term ?? "";
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            await LoadData();
        }
        else
        {
            suppliers = await SupplierService.SearchAsync(searchTerm);
        }
    }

    private async Task AddSupplier()
    {
        // TODO: Implement Dialog
    }

    private async Task Edit(SupplierDto supplier)
    {
        // TODO: Implement Dialog
    }

    private async Task Delete(SupplierDto supplier)
    {
        await SupplierService.DeleteAsync(supplier.Id);
        await LoadData();
    }
}
