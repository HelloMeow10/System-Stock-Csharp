@page "/proveedores"
@using BusinessLogic.Services
@using Contracts
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize] // page requires auth; admin actions gated below
@inject ISupplierService SupplierService
@* Dialog service removed: previous ShowAsync not available *@
@inject AgileStockPro.Web.Services.IAuthService AuthService

<PageTitle>Proveedores</PageTitle>

<div style="padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Proveedores</h1>
        @if (currentUser?.IsAdmin == true)
        {
            <button class="btn btn-primary" @onclick="AddSupplier">Nuevo Proveedor</button>
        }
    </div>

    <input class="search" style="margin-bottom:20px;" placeholder="Buscar por nombre o CUIT..." value="@searchTerm" @oninput="OnSearchInput" />

    @if (suppliers == null)
    {
        <div class="loading" style="padding:1rem; font-size:.9rem; opacity:.8;">Cargando proveedores...</div>
    }
    else
    {
        <table>
            <thead>
                <tr>
                    <th>Id</th>
                    <th>Código</th>
                    <th>Nombre</th>
                    <th>Razón Social</th>
                    <th>CUIT</th>
                    <th>Entrega</th>
                    <th>Desc %</th>
                    <th>Plazo Pago</th>
                    <th>IVA</th>
                    <th>Email</th>
                    <th>Teléfono</th>
                    <th>Prov.</th>
                    <th>Ciudad</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var p in suppliers)
                {
                    <tr>
                        <td>@p.Id</td>
                        <td>@p.Codigo</td>
                        <td>@p.Nombre</td>
                        <td>@p.RazonSocial</td>
                        <td>@p.Cuit</td>
                        <td>@p.TiempoEntrega</td>
                        <td>@p.Descuento</td>
                        <td>@p.PlazoPagoDias</td>
                        <td>@p.CondicionIva</td>
                        <td>@p.Email</td>
                        <td>@p.Telefono</td>
                        <td>@p.Provincia</td>
                        <td>@p.Ciudad</td>
                        <td>
                            @if (currentUser?.IsAdmin == true)
                            {
                                <button class="btn" @onclick="() => Edit(p)">Editar</button>
                                <button class="btn" @onclick="() => Delete(p)">Eliminar</button>
                            }
                            else
                            {
                                <span class="muted" style="font-size:12px;">Solo lectura</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    private IEnumerable<SupplierDto>? suppliers;
    private string searchTerm = "";
    private AgileStockPro.Web.Models.AppUser? currentUser;

    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthService.GetCurrentUserAsync();
        await LoadData();
    }

    private async Task LoadData()
    {
        suppliers = await SupplierService.GetAllAsync();
    }

    private async Task Search(string? term)
    {
        searchTerm = term ?? "";
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            await LoadData();
        }
        else
        {
            suppliers = await SupplierService.SearchAsync(searchTerm);
        }
    }

    private async Task OnSearchInput(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;
        await Search(searchTerm);
    }

    private async Task AddSupplier()
    {
        if (currentUser?.IsAdmin != true) return;
        // TODO: Implement supplier creation UI (modal/dialog) once dialog component confirmed.
        // Placeholder: create minimal supplier with required fields.
        var request = new CreateSupplierRequest { Codigo = "TMP", Nombre = "Nuevo", RazonSocial = "", Cuit = "" };
        await SupplierService.CreateAsync(request);
        await LoadData();
    }

    private async Task Edit(SupplierDto supplier)
    {
        if (currentUser?.IsAdmin != true) return;
        var update = new UpdateSupplierRequest
        {
            Id = supplier.Id,
            Codigo = supplier.Codigo,
            Nombre = supplier.Nombre,
            RazonSocial = supplier.RazonSocial,
            Cuit = supplier.Cuit,
            TiempoEntrega = supplier.TiempoEntrega,
            Descuento = supplier.Descuento,
            IdFormaPago = supplier.IdFormaPago,
            Email = supplier.Email,
            Telefono = supplier.Telefono,
            Direccion = supplier.Direccion,
            Provincia = supplier.Provincia,
            Ciudad = supplier.Ciudad,
            CondicionIva = supplier.CondicionIva,
            PlazoPagoDias = supplier.PlazoPagoDias,
            Observaciones = supplier.Observaciones,
            Contactos = supplier.Contactos
        };
        // Placeholder: directly persist unchanged (would normally open edit UI)
        await SupplierService.UpdateAsync(update);
        await LoadData();
    }

    private async Task Delete(SupplierDto supplier)
    {
        await SupplierService.DeleteAsync(supplier.Id);
        await LoadData();
    }
}
