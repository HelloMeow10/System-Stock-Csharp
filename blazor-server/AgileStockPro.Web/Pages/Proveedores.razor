@page "/proveedores"
@using BusinessLogic.Services
@using Contracts
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize] // page requires auth; admin actions gated below
@inject ISupplierService SupplierService
@* Dialog service removed: previous ShowAsync not available *@
@inject AgileStockPro.Web.Services.IAuthService AuthService

<PageTitle>Proveedores</PageTitle>

<div style="padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Proveedores</h1>
        @if (currentUser?.IsAdmin == true)
        {
            <FluentButton Appearance="Appearance.Accent" OnClick="@AddSupplier">Nuevo Proveedor</FluentButton>
        }
    </div>

    <FluentTextField @bind-Value="searchTerm" Placeholder="Buscar por nombre o CUIT..." Style="width: 300px; margin-bottom: 20px;" @oninput="@(e => Search(e.Value?.ToString()))" />

    @if (suppliers == null)
    {
        <FluentProgressRing />
    }
    else
    {
        <FluentDataGrid Items="@suppliers.AsQueryable()" ResizableColumns="true" GridTemplateColumns="0.5fr 0.8fr 1fr 1fr 0.8fr 0.6fr 0.6fr 0.6fr 0.8fr 0.8fr 0.6fr 1fr 1fr">
                <PropertyColumn Property="@(p => p.Id)" Sortable="true" />
                <PropertyColumn Property="@(p => p.Codigo)" Sortable="true" Title="Código" />
                <PropertyColumn Property="@(p => p.Nombre)" Sortable="true" />
                <PropertyColumn Property="@(p => p.RazonSocial)" Sortable="true" Title="Razón Social" />
                <PropertyColumn Property="@(p => p.Cuit)" Sortable="true" Title="CUIT" />
                <PropertyColumn Property="@(p => p.TiempoEntrega)" Sortable="true" Title="Entrega" />
                <PropertyColumn Property="@(p => p.Descuento)" Sortable="true" Title="Desc %" />
                <PropertyColumn Property="@(p => p.PlazoPagoDias)" Sortable="true" Title="Plazo Pago" />
                <PropertyColumn Property="@(p => p.CondicionIva)" Sortable="true" Title="IVA" />
                <PropertyColumn Property="@(p => p.Email)" Sortable="true" Title="Email" />
                <PropertyColumn Property="@(p => p.Telefono)" Sortable="true" Title="Teléfono" />
                <PropertyColumn Property="@(p => p.Provincia)" Sortable="true" Title="Prov." />
                <PropertyColumn Property="@(p => p.Ciudad)" Sortable="true" Title="Ciudad" />
                <TemplateColumn Title="Acciones">
                @if (currentUser?.IsAdmin == true)
                {
                    <FluentButton IconEnd="@(new Icons.Regular.Size16.Edit())" OnClick="@(() => Edit(context))" Appearance="Appearance.Lightweight" />
                    <FluentButton IconEnd="@(new Icons.Regular.Size16.Delete())" OnClick="@(() => Delete(context))" Appearance="Appearance.Lightweight" />
                }
                else
                {
                    <span class="muted" style="font-size:12px;">Solo lectura</span>
                }
            </TemplateColumn>
        </FluentDataGrid>
    }
</div>

@code {
    private IEnumerable<SupplierDto>? suppliers;
    private string searchTerm = "";
    private AgileStockPro.Web.Models.AppUser? currentUser;

    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthService.GetCurrentUserAsync();
        await LoadData();
    }

    private async Task LoadData()
    {
        suppliers = await SupplierService.GetAllAsync();
    }

    private async Task Search(string? term)
    {
        searchTerm = term ?? "";
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            await LoadData();
        }
        else
        {
            suppliers = await SupplierService.SearchAsync(searchTerm);
        }
    }

    private async Task AddSupplier()
    {
        if (currentUser?.IsAdmin != true) return;
        // TODO: Implement supplier creation UI (modal/dialog) once dialog component confirmed.
        // Placeholder: create minimal supplier with required fields.
        var request = new CreateSupplierRequest { Codigo = "TMP", Nombre = "Nuevo", RazonSocial = "", Cuit = "" };
        await SupplierService.CreateAsync(request);
        await LoadData();
    }

    private async Task Edit(SupplierDto supplier)
    {
        if (currentUser?.IsAdmin != true) return;
        var update = new UpdateSupplierRequest
        {
            Id = supplier.Id,
            Codigo = supplier.Codigo,
            Nombre = supplier.Nombre,
            RazonSocial = supplier.RazonSocial,
            Cuit = supplier.Cuit,
            TiempoEntrega = supplier.TiempoEntrega,
            Descuento = supplier.Descuento,
            IdFormaPago = supplier.IdFormaPago,
            Email = supplier.Email,
            Telefono = supplier.Telefono,
            Direccion = supplier.Direccion,
            Provincia = supplier.Provincia,
            Ciudad = supplier.Ciudad,
            CondicionIva = supplier.CondicionIva,
            PlazoPagoDias = supplier.PlazoPagoDias,
            Observaciones = supplier.Observaciones,
            Contactos = supplier.Contactos
        };
        // Placeholder: directly persist unchanged (would normally open edit UI)
        await SupplierService.UpdateAsync(update);
        await LoadData();
    }

    private async Task Delete(SupplierDto supplier)
    {
        await SupplierService.DeleteAsync(supplier.Id);
        await LoadData();
    }
}
