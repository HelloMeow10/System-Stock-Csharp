<AuthGuard RequireSecuritySetup="true">
@page "/ordenes-compra"
@using BusinessLogic.Services
@using Contracts
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IPurchaseService PurchaseService
@inject IDialogService DialogService
@inject AgileStockPro.Web.Services.IAuthService AuthService
@inject NavigationManager Nav

<PageTitle>Órdenes de Compra</PageTitle>

<div style="padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Órdenes de Compra</h1>
        @if (currentUser?.IsAdmin == true)
        {
            <FluentButton Appearance="Appearance.Accent" OnClick="@CreateOrder">Nueva Orden</FluentButton>
        }
    </div>

    <div style="margin-bottom: 20px;">
        <FluentCheckbox @bind-Value="showDelivered" Label="Mostrar Entregadas" @onchange="@(e => LoadData())" />
    </div>

    @if (orders == null)
    {
        <FluentProgressRing />
    }
    else
    {
        <FluentDataGrid Items="@orders.AsQueryable()" ResizableColumns="true" GridTemplateColumns="0.5fr 1fr 1fr 1fr 1fr">
            <PropertyColumn Property="@(p => p.Id)" Sortable="true" Title="#" />
            <PropertyColumn Property="@(p => p.Proveedor)" Sortable="true" />
            <PropertyColumn Property="@(p => p.Fecha)" Format="dd/MM/yyyy" Sortable="true" />
            <PropertyColumn Property="@(p => p.Total)" Format="C2" Sortable="true" />
            <TemplateColumn Title="Entregado">
                @if (context.Entregado)
                {
                    <FluentBadge Appearance="Appearance.Accent">Sí</FluentBadge>
                }
                else
                {
                    <FluentButton Appearance="Appearance.Lightweight" OnClick="@(() => Nav.NavigateTo($"/ordenes-compra/recibir/{context.Id}"))">Recibir</FluentButton>
                }
            </TemplateColumn>
        </FluentDataGrid>
    }
    </div>

</AuthGuard>

@code {
    private IEnumerable<PurchaseOrderDto>? orders;
    private bool showDelivered = false;

    private AgileStockPro.Web.Models.AppUser? currentUser;
    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthService.GetCurrentUserAsync();
        await LoadData();
    }

    private async Task LoadData()
    {
        // Load via IAppDataService API-backed service for now
        var dataSvc = (AgileStockPro.Web.Services.IAppDataService?)AuthService is null ? null : null;
        // Fallback to injected PurchaseService if available
        orders = await PurchaseService.GetOrdersAsync(null);
    }

    private async Task CreateOrder()
    {
        // TODO: Implement Dialog for creating order
    }
}
