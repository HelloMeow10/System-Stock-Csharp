@page "/change-password"
@inject AgileStockPro.Web.Services.IAuthService Auth
@inject IToastService Toast

<PageHeader Title="Cambiar contraseña" />

<EditForm Model="model" OnValidSubmit="DoChange">
    <DataAnnotationsValidator />
    <div class="panel">
        <div class="panel-header">Actualizar</div>
        <div style="display:grid; grid-template-columns: 160px 1fr; gap:.5rem; align-items:center;">
            <label>Actual</label>
            <InputText type="password" class="input" @bind-Value="model.Current" />
            <label>Nueva</label>
            <InputText type="password" class="input" @bind-Value="model.New" />
        </div>
        <div style="margin-top:1rem; display:flex; gap:.5rem">
            <button class="btn btn-primary" disabled="@busy">Guardar</button>
        </div>
        @if (!string.IsNullOrWhiteSpace(msg))
        {
            <div style="margin-top:.5rem">@msg</div>
        }
    </div>
</EditForm>

@code {
    class Model { public string Current { get; set; } = string.Empty; public string New { get; set; } = string.Empty; }
    Model model = new();
    [Inject] NavigationManager Nav { get; set; } = default!;
    string? msg; bool busy;
    private async Task DoChange()
    {
        busy = true; msg = null;
        var ok = await Auth.ChangePasswordAsync(model.Current, model.New);
        if (ok)
        {
            msg = "Contraseña actualizada";
            Toast.ShowSuccess(msg);
            await Task.Delay(600);
            Nav.NavigateTo("/dashboard", true);
        }
        else
        {
            msg = "No se pudo actualizar (verifique la actual o la política)";
            Toast.ShowError(msg);
        }
        busy = false;
    }
}
