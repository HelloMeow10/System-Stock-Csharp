@page "/change-password"
@inject AgileStockPro.Web.Services.IAuthService Auth
@inject AgileStockPro.Web.Services.IUserStore Store
@inject IToastService Toast
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components
@using AgileStockPro.Web.Components.Shared
@inject IJSRuntime JS

@using Microsoft.FluentUI.AspNetCore.Components
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons

<PageHeader Title="Cambiar contraseña" />

<EditForm EditContext="_editContext" OnSubmit="OnSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div class="panel animate__animated animate__fadeIn">
        <div class="panel-header">Actualizar contraseña</div>
        <div class="panel-body">
        <div class="form-group mb-3">
            <label for="actual" class="form-label">Contraseña actual</label>
            <div class="input-with-icon">
                <InputText id="actual" type="@(showCurrent ? "text" : "password")" class="form-control" @bind-Value="model.Current" />
                <button type="button" class="icon-btn" @onclick="ToggleShowCurrent" aria-label="Mostrar contraseña actual">
                    @if (showCurrent)
                    {
                        <FluentIcon class="icon-svg" Value="@(new Icons.Regular.Size20.Eye())" />
                    }
                    else
                    {
                        <FluentIcon class="icon-svg" Value="@(new Icons.Regular.Size20.EyeOff())" />
                    }
                </button>
                <ValidationMessage For="() => model.Current" />
            </div>
        </div>

        <div class="form-group mb-3">
            <label for="nueva" class="form-label">Nueva contraseña</label>
            <div class="input-with-icon">
                <InputText id="nueva" type="@(showNew ? "text" : "password")" class="form-control" @bind-Value="model.New" @oninput="@(e => OnNewChanged(e?.Value?.ToString()))" />
                <button type="button" class="icon-btn" @onclick="ToggleShowNew" aria-label="Mostrar nueva contraseña">
                    @if (showNew)
                    {
                        <FluentIcon class="icon-svg" Value="@(new Icons.Regular.Size20.Eye())" />
                    }
                    else
                    {
                        <FluentIcon class="icon-svg" Value="@(new Icons.Regular.Size20.EyeOff())" />
                    }
                </button>
                <ValidationMessage For="() => model.New" />
            </div>
            <ul class="password-reqs mt-2">
                <li class="@(lenOk ? "ok" : "fail")">Mínimo @policy.MinLength caracteres</li>
                @if (policy.RequireUpperLower)
                {
                    <li class="@(upperLowerOk ? "ok" : "fail")">Debe contener mayúscula y minúscula</li>
                }
                @if (policy.RequireNumber)
                {
                    <li class="@(numberOk ? "ok" : "fail")">Debe contener un número</li>
                }
                @if (policy.RequireSpecial)
                {
                    <li class="@(specialOk ? "ok" : "fail")">Debe contener un caracter especial</li>
                }
            </ul>
        </div>

        <div class="d-flex justify-content-end align-items-center gap-2">
            <button type="button" class="btn btn-primary px-4" @onclick="SubmitClicked">
                @(busy ? (MarkupString)"<span class='spinner-border spinner-border-sm me-2' role='status' aria-hidden='true'></span> Guardando..." : (MarkupString)"Guardar")
            </button>
        </div>

        <div class="mt-3" aria-live="polite" aria-atomic="true">
            @if (!string.IsNullOrWhiteSpace(msg))
            {
                <div class="alert @(isError ? "alert-danger" : "alert-success")" role="status">@msg</div>
            }
        </div>
        </div>
    </div>
</EditForm>

@code {
    class Model { 
        [Required(ErrorMessage = "Ingresá tu contraseña actual")]
        public string Current { get; set; } = string.Empty; 
        [Required(ErrorMessage = "Ingresá la nueva contraseña")]
        public string New { get; set; } = string.Empty; 
    }
    Model model = new();
    private EditContext _editContext = default!;
    [Inject] NavigationManager Nav { get; set; } = default!;
    string? msg; bool isError; bool busy; bool isValid; AgileStockPro.Web.Models.SecurityPolicy policy = new();
    bool lenOk, upperLowerOk, numberOk, specialOk;
    protected override void OnInitialized()
    {
        // Asegurar que EditContext no sea null en el primer render
        _editContext = new EditContext(model);
    }

    protected override async Task OnInitializedAsync()
    {
        // Verificar sesión y cargar política fresca
        var user = await Auth.GetCurrentUserAsync();
        if (user is null)
        {
            Nav.NavigateTo($"/login?returnUrl={Uri.EscapeDataString("/change-password")}", true);
            return;
        }
        try
        {
            policy = await Store.GetPolicyAsync();
        }
        catch
        {
            Toast.ShowError("No se pudo obtener la política de seguridad. Iniciá sesión nuevamente.");
            Nav.NavigateTo($"/login?returnUrl={Uri.EscapeDataString("/change-password")}", true);
            return;
        }
        Validate(model.New);
    }
    void OnNewChanged(string? v){ model.New = v ?? string.Empty; Validate(model.New); }
    void Validate(string? value)
    {
        var v = value ?? string.Empty;
        lenOk = v.Length >= policy.MinLength;
        upperLowerOk = (v.Any(char.IsUpper) && v.Any(char.IsLower));
        numberOk = v.Any(char.IsDigit);
        specialOk = v.Any(ch => !char.IsLetterOrDigit(ch));
        isValid = lenOk
            && (!policy.RequireUpperLower || upperLowerOk)
            && (!policy.RequireNumber || numberOk)
            && (!policy.RequireSpecial || specialOk);
        StateHasChanged();
    }
    private async Task DoChange()
    {
        busy = true; msg = null; isError = false;
        Toast.ShowInfo("Intentando cambiar la contraseña...");
        var result = await Auth.ChangePasswordAsync(model.Current, model.New);
        if (result.Success)
        {
            var updatedUser = await Auth.GetCurrentUserAsync();
            if (updatedUser != null)
            {
                await Store.SetCurrentUserAsync(updatedUser);
            }
            msg = "Contraseña actualizada";
            Toast.ShowSuccess(msg);
            await Task.Delay(600);

            // Only redirect to security questions if the user hasn't set them up yet
            // or if this was a mandatory password change (first login).
            // We can check if the user has questions set up.
            var questions = await Auth.GetSecurityQuestionsAsync(updatedUser!.Username);
            if (questions == null || !questions.Any())
            {
                 Nav.NavigateTo("/configurar-seguridad", true);
            }
            else
            {
                 Nav.NavigateTo("/dashboard", true);
            }
        }
        else
        {
            msg = result.ErrorMessage ?? "No se pudo actualizar (verifique la actual o la política)";
            isError = true;
            Toast.ShowError(msg);
            // Mantenerse en la pantalla para que el usuario corrija y reintente
        }
        busy = false;
    }

    private async Task OnSubmit(EditContext ctx)
    {
        // Forzar validación y decidir qué hacer
        var valid = ctx.Validate();
        if (valid)
        {
            await DoChange();
        }
        else
        {
            msg = "Completá los campos requeridos";
            isError = true;
            Toast.ShowError(msg);
        }
    }

    private async Task SubmitClicked()
    {
        if (busy) return;
        if (_editContext is null)
        {
            _editContext = new EditContext(model);
        }
        msg = "Procesando..."; isError = false; StateHasChanged();
        var valid = _editContext.Validate();
        if (!valid)
        {
            msg = "Completá los campos requeridos";
            isError = true;
            Toast.ShowError(msg);
            return;
        }
        try
        {
            await DoChange();
        }
        catch (Exception ex)
        {
            msg = string.IsNullOrWhiteSpace(ex.Message) ? "Error inesperado" : ex.Message;
            isError = true;
        }
    }

    private bool showCurrent = false;
    private bool showNew = false;
    private void ToggleShowCurrent() => showCurrent = !showCurrent;
    private void ToggleShowNew() => showNew = !showNew;
}
