@page "/change-password"
@inject AgileStockPro.Web.Services.IAuthService Auth
@inject AgileStockPro.Web.Services.IUserStore Store
@inject IToastService Toast
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components
@using AgileStockPro.Web.Components.Shared
@inject IJSRuntime JS

<PageHeader Title="Cambiar contraseña" />

<EditForm EditContext="_editContext" OnSubmit="OnSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />
    <div class="panel animate__animated animate__fadeIn">
        <div class="panel-header">Actualizar contraseña</div>
        <div class="form-group mb-3">
            <label for="actual" class="form-label">Contraseña actual</label>
            <InputText id="actual" type="password" class="form-control" @bind-Value="model.Current" />
            <ValidationMessage For="() => model.Current" />
        </div>
        <div class="form-group mb-3">
            <label for="nueva" class="form-label">Nueva contraseña</label>
            <InputText id="nueva" type="password" class="form-control" @bind-Value="model.New" @oninput="@(e => OnNewChanged(e?.Value?.ToString()))" />
            <ValidationMessage For="() => model.New" />
            <ul class="muted mt-2" style="padding-left:1.1rem;">
                <li style="color:@(lenOk?"#198754":"#dc3545")">Mínimo @policy.MinLength caracteres</li>
                @if (policy.RequireUpperLower)
                {
                    <li style="color:@(upperLowerOk?"#198754":"#dc3545")">Debe contener mayúscula y minúscula</li>
                }
                @if (policy.RequireNumber)
                {
                    <li style="color:@(numberOk?"#198754":"#dc3545")">Debe contener un número</li>
                }
                @if (policy.RequireSpecial)
                {
                    <li style="color:@(specialOk?"#198754":"#dc3545")">Debe contener un caracter especial</li>
                }
            </ul>
        </div>
        <div class="d-flex justify-content-end align-items-center gap-2">
            <button type="button" class="btn btn-primary px-4" @onclick="SubmitClicked">
                @(busy ? (MarkupString)"<span class='spinner-border spinner-border-sm me-2' role='status' aria-hidden='true'></span> Guardando..." : (MarkupString)"Guardar")
            </button>
            <small class="text-muted">estado: busy=@busy | isValid=@isValid</small>
            <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="@(()=>{ msg = "Click recibido"; isError=false; StateHasChanged(); })">Probar click</button>
        </div>
        <div class="mt-3" aria-live="polite" aria-atomic="true">
            @if (!string.IsNullOrWhiteSpace(msg))
            {
                <div class="alert @(isError ? "alert-danger" : "alert-success")" role="status">@msg</div>
            }
        </div>
    </div>
</EditForm>

@code {
    class Model { 
        [Required(ErrorMessage = "Ingresá tu contraseña actual")]
        public string Current { get; set; } = string.Empty; 
        [Required(ErrorMessage = "Ingresá la nueva contraseña")]
        public string New { get; set; } = string.Empty; 
    }
    Model model = new();
    private EditContext _editContext = default!;
    [Inject] NavigationManager Nav { get; set; } = default!;
    string? msg; bool isError; bool busy; bool isValid; AgileStockPro.Web.Models.SecurityPolicy policy = new();
    bool lenOk, upperLowerOk, numberOk, specialOk;
    protected override void OnInitialized()
    {
        // Asegurar que EditContext no sea null en el primer render
        _editContext = new EditContext(model);
    }

    protected override async Task OnInitializedAsync()
    {
        // Verificar sesión y cargar política fresca
        var user = await Auth.GetCurrentUserAsync();
        if (user is null)
        {
            Nav.NavigateTo($"/login?returnUrl={Uri.EscapeDataString("/change-password")}", true);
            return;
        }
        try
        {
            policy = await Store.GetPolicyAsync();
        }
        catch
        {
            Toast.ShowError("No se pudo obtener la política de seguridad. Iniciá sesión nuevamente.");
            Nav.NavigateTo($"/login?returnUrl={Uri.EscapeDataString("/change-password")}", true);
            return;
        }
        Validate(model.New);
    }
    void OnNewChanged(string? v){ model.New = v ?? string.Empty; Validate(model.New); }
    void Validate(string? value)
    {
        var v = value ?? string.Empty;
        lenOk = v.Length >= policy.MinLength;
        upperLowerOk = (v.Any(char.IsUpper) && v.Any(char.IsLower));
        numberOk = v.Any(char.IsDigit);
        specialOk = v.Any(ch => !char.IsLetterOrDigit(ch));
        isValid = lenOk
            && (!policy.RequireUpperLower || upperLowerOk)
            && (!policy.RequireNumber || numberOk)
            && (!policy.RequireSpecial || specialOk);
        StateHasChanged();
    }
    private async Task DoChange()
    {
        busy = true; msg = null; isError = false;
        Toast.ShowInfo("Intentando cambiar la contraseña...");
        var result = await Auth.ChangePasswordAsync(model.Current, model.New);
        if (result.Success)
        {
            var updatedUser = await Auth.GetCurrentUserAsync();
            if (updatedUser != null)
            {
                await Store.SetCurrentUserAsync(updatedUser);
            }
            msg = "Contraseña actualizada";
            Toast.ShowSuccess(msg);
            await Task.Delay(600);
            Nav.NavigateTo("/dashboard", true);
        }
        else
        {
            msg = result.ErrorMessage ?? "No se pudo actualizar (verifique la actual o la política)";
            isError = true;
            Toast.ShowError(msg);
            // Mantenerse en la pantalla para que el usuario corrija y reintente
        }
        busy = false;
    }

    private async Task OnSubmit(EditContext ctx)
    {
        // Forzar validación y decidir qué hacer
        var valid = ctx.Validate();
        if (valid)
        {
            await DoChange();
        }
        else
        {
            msg = "Completá los campos requeridos";
            isError = true;
            Toast.ShowError(msg);
        }
    }

    private async Task SubmitClicked()
    {
        if (busy) return;
        if (_editContext is null)
        {
            _editContext = new EditContext(model);
        }
        await JS.InvokeVoidAsync("console.log", "SubmitClicked fired", DateTime.UtcNow.ToString("o"));
        msg = "Procesando..."; isError = false; StateHasChanged();
        var valid = _editContext.Validate();
        if (!valid)
        {
            msg = "Completá los campos requeridos";
            isError = true;
            Toast.ShowError(msg);
            return;
        }
        try
        {
            await DoChange();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "DoChange error", ex.Message);
            msg = string.IsNullOrWhiteSpace(ex.Message) ? "Error inesperado" : ex.Message;
            isError = true;
        }
    }
}
