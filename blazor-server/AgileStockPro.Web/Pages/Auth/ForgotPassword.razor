@page "/forgot-password"
@layout AgileStockPro.Web.Components.LoginLayout
@inject AgileStockPro.Web.Services.IAuthService Auth
@inject IToastService Toast

<div class="login-wrapper forgot-password-page">
    <div class="lgn-card">
        <div class="lgn-header">
            <div class="lgn-header-main">Recuperar contraseña</div>
            <div class="lgn-header-sub">
                @if (questions == null)
                {
                    <span>Ingrese su usuario para cargar las preguntas de seguridad.</span>
                }
                else
                {
                    <span>Responda las preguntas para generar una contraseña temporal.</span>
                }
            </div>
        </div>

        @if (questions == null)
        {
            <div class="lgn-section">
                <div class="lgn-field input-wrap">
                    <input id="fp-username" class="lgn-input" @bind-value="username" placeholder=" " aria-labelledby="label-fp-username" required />
                    <label id="label-fp-username" for="fp-username">Usuario</label>
                    <span class="input-underline"></span>
                </div>
            </div>
            <div class="lgn-actions">
                <button type="button" class="lgn-btn lgn-btn-primary" disabled="@busy" @onclick="LoadQuestions">@(busy?"Cargando…":"Continuar")</button>
                <a href="/login" class="lgn-btn lgn-btn-secondary">Volver al login</a>
            </div>
        }
        else
        {
            <div class="lgn-section">
                @foreach (var q in questions!)
                {
                    <div class="lgn-field input-wrap">
                        <input id="fp-q-@q.GetHashCode()" class="lgn-input" @bind-value="answers[q]" placeholder=" " aria-labelledby="label-fp-q-@q.GetHashCode()" />
                        <label id="label-fp-q-@q.GetHashCode()" for="fp-q-@q.GetHashCode()">@q</label>
                        <span class="input-underline"></span>
                    </div>
                }
            </div>
            <div class="lgn-actions">
                <button type="button" class="lgn-btn lgn-btn-primary" disabled="@busy" @onclick="Reset">@(busy?"Procesando…":"Generar contraseña")</button>
                <button type="button" class="lgn-btn lgn-btn-secondary" @onclick="ResetFlow">Cancelar</button>
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(info))
        {
            <div class="lgn-alert lgn-alert-info">@info</div>
        }
        @if (!string.IsNullOrWhiteSpace(error))
        {
            <div class="lgn-alert lgn-alert-error">@error</div>
        }
    </div>
</div>

@code {
    private string username = string.Empty;
    private List<string>? questions;
    private Dictionary<string, string> answers = new();
    private string? error;
    private string? info;
    private bool busy;

    private async Task LoadQuestions()
    {
        error = info = null; busy = true;
        try
        {
            var qs = await Auth.GetSecurityQuestionsAsync(username);
            if (qs == null || qs.Count == 0)
            {
                error = "Usuario no encontrado";
                questions = null;
                Toast.ShowError(error);
                return;
            }
            questions = qs.ToList();
            answers = questions.ToDictionary(q => q, _ => string.Empty);
        }
        catch (Exception ex)
        {
            error = ex.Message;
            Toast.ShowError(error);
        }
        finally { busy = false; }
    }

    private async Task Reset()
    {
        error = info = null; busy = true;
        if (string.IsNullOrWhiteSpace(username) || questions == null)
        {
            error = "Complete los datos";
            Toast.ShowError(error);
            busy = false;
            return;
        }
        var result = await Auth.ResetPasswordAsync(username, answers);
        if (!result.Success)
        {
            error = result.Error ?? "No se pudo resetear";
            Toast.ShowError(error);
            busy = false;
            return;
        }
        // Simulación de envío por email: mostramos la contraseña temporal
        info = $"Contraseña temporal: {result.TempPassword}. Deberá cambiarla al ingresar.";
        Toast.ShowSuccess("Se envió una contraseña temporal al correo (demo)");
        busy = false;
    }

    private void ResetFlow()
    {
        questions = null;
        answers.Clear();
        error = info = null;
    }
}
