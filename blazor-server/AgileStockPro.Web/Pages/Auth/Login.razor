@page "/login"
@inject NavigationManager Nav
@inject AgileStockPro.Web.Services.IAuthService Auth
@inject AuthenticationStateProvider AuthStateProvider
@inject IToastService Toast
@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using Microsoft.FluentUI.AspNetCore.Components
@using Icons = Microsoft.FluentUI.AspNetCore.Components.Icons
@layout AgileStockPro.Web.Components.LoginLayout

<div class="login-wrapper login-page">
    <EditForm Model="model" OnValidSubmit="HandleLogin" OnInvalidSubmit="OnInvalidLogin">
        <DataAnnotationsValidator />
        <div class="lgn-card">
            <div class="lgn-header">
                <div class="lgn-header-main">Ingreso</div>
                <div class="lgn-header-sub">
                    @if (!require2FA)
                    {
                        <span>Ingrese sus credenciales para acceder al sistema</span>
                    }
                    else
                    {
                        <span>Ingrese el código enviado. Mejora la seguridad de su cuenta.</span>
                    }
                </div>
            </div>

            @if (!require2FA)
            {
                <div class="lgn-section lgn-section-credentials">
                    <div class="lgn-field input-wrap">
                        <input id="login-username" class="lgn-input" @bind="model.Username" placeholder=" " aria-labelledby="label-username" required />
                        <label id="label-username" for="login-username">Usuario</label>
                        <span class="input-underline"></span>
                    </div>
                    <div class="lgn-field input-wrap">
                        <input id="login-password" type="@(showPassword ? "text" : "password")" class="lgn-input" @bind="model.Password" placeholder=" " aria-labelledby="label-password" required />
                        <label id="label-password" for="login-password">Contraseña</label>
                        <span class="input-underline"></span>
                        <button type="button" class="lgn-password-toggle" data-active="@showPassword" @onclick="TogglePassword" aria-label="@(showPassword?"Ocultar contraseña":"Mostrar contraseña")">
                            @if (showPassword)
                            {
                                <FluentIcon Value="@(new Icons.Regular.Size20.Eye())" />
                            }
                            else
                            {
                                <FluentIcon Value="@(new Icons.Regular.Size20.EyeOff())" />
                            }
                        </button>
                    </div>
                </div>
                <div class="lgn-actions">
                    <button type="submit" class="lgn-btn lgn-btn-primary" disabled="@busy">@(busy ? "Ingresando…" : "Ingresar")</button>
                    <a href="/forgot-password" class="lgn-btn lgn-btn-secondary">Olvidé mi contraseña</a>
                </div>
            }
            else
            {
                <div class="lgn-section lgn-section-2fa">
                    <div class="lgn-field">
                        <input class="lgn-input" placeholder="Código 2FA" aria-label="Código 2FA" @bind-value="twoFactorCode" @onkeydown="@Enter2FA" />
                        @if (!string.IsNullOrEmpty(error2FA))
                        {
                            <div class="lgn-alert lgn-alert-error">@error2FA</div>
                        }
                    </div>
                    <div class="lgn-actions">
                        <button type="button" class="lgn-btn lgn-btn-primary" disabled="@busy2fa" @onclick="VerifyCode">@(busy2fa ? "Verificando…" : "Verificar")</button>
                        <button type="button" class="lgn-btn lgn-btn-secondary" @onclick="()=>{ require2FA=false; twoFactorCode=string.Empty; }">Volver</button>
                    </div>
                    <div class="lgn-alert lgn-alert-info">Se envió un código al correo. Revisa la consola.</div>
                </div>
            }

            @if (!string.IsNullOrEmpty(error) && !require2FA)
            {
                <div class="lgn-alert lgn-alert-error">@error</div>
            }
        </div>
    </EditForm>
</div>

@code {
    class LoginModel
    {
        [Required(ErrorMessage = "Usuario requerido")] 
        public string Username { get; set; } = string.Empty;
        [Required(ErrorMessage = "Contraseña requerida")] 
        public string Password { get; set; } = string.Empty;
    }

    private LoginModel model = new();
    private bool busy;
    private string? error;
    private bool require2FA;
    private string twoFactorCode = string.Empty;
    private bool busy2fa;
    private string? error2FA;
    private bool showPassword = false;

    private void OnInvalidLogin()
    {
        error = "Complete usuario y contraseña";
        Toast.ShowError(error);
    }

    private void TogglePassword()
    {
        showPassword = !showPassword;
    }

    private async Task HandleLogin()
    {
    busy = true; error = null; require2FA = false;
        var result = await Auth.LoginAsync(model.Username, model.Password);
    busy = false;
        if (!result.Success)
        {
            error = result.Error ?? "Login inválido";
            Toast.ShowError(error);
            return;
        }
        if (result.Requires2FA)
        {
            require2FA = true;
            StateHasChanged();
            return;
        }
        // Sync Blazor auth state so [Authorize] works
        if (AuthStateProvider is AgileStockPro.Web.Auth.CustomAuthenticationStateProvider custom)
        {
            await custom.LoginAsync(model.Username, model.Password);
        }
        Toast.ShowSuccess("Sesión iniciada");
        var user = await Auth.GetCurrentUserAsync();
        if (user?.MustChangePassword == true)
        {
            Nav.NavigateTo("/change-password", true);
        }
        else
        {
            var ru = GetReturnUrl();
            if (!string.IsNullOrWhiteSpace(ru))
            {
                Nav.NavigateTo(ru!, true);
            }
            else
            {
                Nav.NavigateTo("/dashboard", true);
            }
        }
    }

    private async Task VerifyCode()
    {
    error2FA = null; busy2fa = true;
        var ok = await Auth.Verify2FAAsync(twoFactorCode);
    busy2fa = false;
        if (!ok)
        {
            error2FA = "Código inválido";
            Toast.ShowError(error2FA);
            return;
        }
        // After 2FA, ensure auth state reflects logged-in user
        if (AuthStateProvider is AgileStockPro.Web.Auth.CustomAuthenticationStateProvider custom)
        {
            await custom.LoginAsync(model.Username, model.Password);
        }
        Toast.ShowSuccess("2FA verificado");
        var user = await Auth.GetCurrentUserAsync();
        if (user?.MustChangePassword == true)
        {
            Nav.NavigateTo("/change-password", true);
        }
        else
        {
            Nav.NavigateTo("/dashboard", true);
        }
    }

    private async Task Enter2FA(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await VerifyCode();
        }
    }

    private string? GetReturnUrl()
    {
        try
        {
            var uri = new Uri(Nav.Uri);
            var q = uri.Query;
            if (string.IsNullOrEmpty(q)) return null;
            // naive parse: ?returnUrl=/algo&x=y
            foreach (var part in q.TrimStart('?').Split('&', StringSplitOptions.RemoveEmptyEntries))
            {
                var kv = part.Split('=', 2);
                if (kv.Length == 2 && string.Equals(kv[0], "returnUrl", StringComparison.OrdinalIgnoreCase))
                {
                    var val = Uri.UnescapeDataString(kv[1]);
                    // prevent open redirects
                    if (!string.IsNullOrWhiteSpace(val) && val.StartsWith('/') && !val.Contains("://")) return val;
                }
            }
        }
        catch { }
        return null;
    }
}
