@page "/alertas"
@using BusinessLogic.Services
@using Contracts
@inject IStockService StockService
@inject IToastService Toast

<PageTitle>Alertas de Stock</PageTitle>

<div style="padding: 20px; max-width: 1200px; margin: 0 auto;">
    <h1>Alertas de Stock</h1>

    <div style="margin-bottom: 20px;">
        <FluentButton Appearance="Appearance.Accent" OnClick="LoadAlerts">Actualizar</FluentButton>
    </div>

    @if (isLoading)
    {
        <FluentProgressRing />
    }
    else if (alerts == null || !alerts.Any())
    {
        <p>No hay alertas activas.</p>
    }
    else
    {
        <FluentDataGrid Items="@alerts.AsQueryable()" ResizableColumns="true">
            <PropertyColumn Property="@(p => p.Codigo)" Title="Código" Sortable="true" />
            <PropertyColumn Property="@(p => p.Producto)" Title="Producto" Sortable="true" />
            <PropertyColumn Property="@(p => p.StockActual)" Title="Stock Actual" Sortable="true" />
            <PropertyColumn Property="@(p => p.StockMinimo)" Title="Stock Mínimo" />
            <PropertyColumn Property="@(p => p.PuntoReposicion)" Title="Punto Reposición" />
            <PropertyColumn Property="@(p => p.Lote)" Title="Lote" />
            <PropertyColumn Property="@(p => p.FechaVencimiento)" Format="dd/MM/yyyy" Title="Vencimiento" Sortable="true" />
            <TemplateColumn Title="Tipo Alerta" Sortable="true" SortBy="@sortByType">
                <FluentBadge Appearance="@GetBadgeAppearance(context.Severidad)">
                    @context.TipoAlerta
                </FluentBadge>
            </TemplateColumn>
        </FluentDataGrid>
    }
</div>

@code {
    private IEnumerable<StockAlertDto>? alerts;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadAlerts();
    }

    private async Task LoadAlerts()
    {
        isLoading = true;
        try
        {
            alerts = await StockService.GetAlertsAsync();
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Error cargando alertas: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private Appearance GetBadgeAppearance(string severity)
    {
        return severity switch
        {
            "danger" => Appearance.Accent, // Red-ish usually, or use custom style
            "warning" => Appearance.Neutral, // Orange-ish
            _ => Appearance.Neutral
        };
    }

    GridSort<StockAlertDto> sortByType = GridSort<StockAlertDto>
        .ByAscending(p => p.TipoAlerta);
}
