@page "/alertas"
@using AgileStockPro.Web.Services
@using AgileStockPro.Web.Models
@using AgileStockPro.Web.Components
@using AgileStockPro.Web.Components.Shared
@inject IAppDataService Data
@inject AgileStockPro.Web.Services.IAuthService AuthService
@inject AgileStockPro.Web.Services.Api.ApiProductService ProductApi

<AuthGuard>
	<PageHeader Title="Alertas" />

	@if (!string.IsNullOrWhiteSpace(error))
	{
		<div class="error">@error</div>
	}
	else if (items is null || productAlerts is null)
	{
		<p>Cargando...</p>
	}
	else if ((items?.Count ?? 0) == 0 && (productAlerts?.Count ?? 0) == 0)
	{
		<p class="muted">No hay alertas.</p>
	}
	else
	{
		var list = items?.Where(a => a is not null).ToList() ?? new List<Alerta>();
		<table>
			<thead>
				<tr>
					<th>Fecha</th>
					<th>Mensaje</th>
					<th>Severidad</th>
				</tr>
			</thead>
			<tbody>
			@foreach (var a in list)
			{
				<tr>
					<td>@(a?.Date.ToString("dd/MM/yyyy HH:mm") ?? "-")</td>
					<td>@(a?.Message ?? "-")</td>
					<td>
						<span class="badge @((a?.Severity ?? "info") == "danger" ? "danger" : (a?.Severity ?? "info") == "warning" ? "warning" : "success")">@(a?.Severity ?? "info")</span>
					</td>
				</tr>
			}
			</tbody>
		</table>

        <h4 style="margin-top:28px;">Alertas de Productos</h4>
        @if ((productAlerts?.Count ?? 0) == 0)
        {
            <p class="muted">No hay alertas de stock o vencimiento.</p>
        }
        else
        {
            <table>
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Nombre</th>
                        <th>Stock</th>
                        <th>Min</th>
                        <th>Reposición</th>
                        <th>Estado</th>
                        <th>Lote</th>
                        <th>Ctrl Venc.</th>
                        <th>Días Venc.</th>
                        <th>Severidad</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var pa in productAlerts!)
                {
                    <tr>
                        <td>@pa.Codigo</td>
                        <td>@pa.Nombre</td>
                        <td>@pa.Stock</td>
                        <td>@pa.Min</td>
                        <td>@pa.Repo</td>
                        <td>@pa.Tipo</td>
                        <td>@(pa.LoteObligatorio ? "Sí" : "No")</td>
                        <td>@(pa.ControlVencimiento ? "Sí" : "No")</td>
                        <td>@pa.DiasVencimiento</td>
                        <td>
                            <span class="badge @(pa.Severidad == "danger" ? "danger" : pa.Severidad == "warning" ? "warning" : "success")">@pa.Severidad</span>
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        }
	}
</AuthGuard>

@code {
	private IReadOnlyList<Alerta>? items;
	private List<ProductAlert>? productAlerts;
	private string? error;
	private AgileStockPro.Web.Models.AppUser? currentUser;
	protected override async Task OnInitializedAsync()
	{
		try
		{
			currentUser = await AuthService.GetCurrentUserAsync();
			items = await Data.GetAlertsAsync() ?? Array.Empty<Alerta>();
			var products = await ProductApi.GetProductsAsync();
			productAlerts = BuildProductAlerts(products.ToList());
		}
		catch (Exception ex)
		{
			error = ex.Message;
		}
	}

	private static List<ProductAlert> BuildProductAlerts(List<Product> products)
	{
		var result = new List<ProductAlert>();
		foreach (var p in products)
		{
			string? tipo = null; string severidad = "info";
			if (p.Stock <= Math.Max(1, p.MinStock / 2)) { tipo = "Stock Crítico"; severidad = "danger"; }
			else if (p.Stock < p.MinStock) { tipo = "Stock Bajo"; severidad = "warning"; }
			else if (p.PuntoReposicion > 0 && p.Stock <= p.PuntoReposicion) { tipo = "Reposición"; severidad = "warning"; }
			if (p.ControlVencimiento && p.DiasVencimiento > 0)
			{
				// Sin fecha de fabricación / vencimiento específica solo mostramos control activo.
				var vencTipo = p.DiasVencimiento <= 30 ? "Vencimiento Próximo" : "Control Vencimiento";
				// Si ya había tipo, lo concatenamos.
				if (tipo is null) tipo = vencTipo; else tipo += $" + {vencTipo}";
				severidad = p.DiasVencimiento <= 30 ? "warning" : severidad;
			}
			if (tipo is not null)
			{
				result.Add(new ProductAlert
				{
					Codigo = p.Id,
					Nombre = p.Name,
					Stock = p.Stock,
					Min = p.MinStock,
					Repo = p.PuntoReposicion,
					Tipo = tipo,
					Severidad = severidad,
					LoteObligatorio = p.LoteObligatorio,
					ControlVencimiento = p.ControlVencimiento,
					DiasVencimiento = p.DiasVencimiento
				});
			}
		}
		return result.OrderByDescending(a => a.Severidad == "danger").ThenByDescending(a => a.Severidad == "warning").ToList();
	}

	class ProductAlert
	{
		public string Codigo { get; set; } = string.Empty;
		public string Nombre { get; set; } = string.Empty;
		public int Stock { get; set; }
		public int Min { get; set; }
		public int Repo { get; set; }
		public string Tipo { get; set; } = string.Empty;
		public string Severidad { get; set; } = string.Empty;
		public bool LoteObligatorio { get; set; }
		public bool ControlVencimiento { get; set; }
		public int DiasVencimiento { get; set; }
	}
}
