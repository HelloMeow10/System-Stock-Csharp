@page "/alertas"
@using BusinessLogic.Services
@using Contracts
@inject IStockService StockService
@inject IToastService Toast

<PageTitle>Alertas de Stock</PageTitle>

<div style="padding: 20px; max-width: 1200px; margin: 0 auto;">
    <h1>Alertas de Stock</h1>

    <div style="margin-bottom: 20px;">
        <button class="btn btn-primary" @onclick="LoadAlerts">Actualizar</button>
    </div>

    @if (isLoading)
    {
        <div class="loading-inline" aria-live="polite">Cargando…</div>
    }
    else if (alerts == null || !alerts.Any())
    {
        <p>No hay alertas activas.</p>
    }
    else
    {
        <div class="data-grid">
            <table>
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Producto</th>
                        <th>Stock Actual</th>
                        <th>Stock Mínimo</th>
                        <th>Punto Reposición</th>
                        <th>Lote</th>
                        <th>Vencimiento</th>
                        <th>Tipo Alerta</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in alerts)
                    {
                        <tr>
                            <td>@p.Codigo</td>
                            <td>@p.Producto</td>
                            <td>@p.StockActual</td>
                            <td>@p.StockMinimo</td>
                            <td>@p.PuntoReposicion</td>
                            <td>@p.Lote</td>
                            <td>@(p.FechaVencimiento?.ToString("dd/MM/yyyy") ?? "-")</td>
                            <td><span class="badge @GetBadgeClass(p.Severidad)">@p.TipoAlerta</span></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private IEnumerable<StockAlertDto>? alerts;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadAlerts();
    }

    private async Task LoadAlerts()
    {
        isLoading = true;
        try
        {
            alerts = await StockService.GetAlertsAsync();
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Error cargando alertas: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetBadgeClass(string severity)
    {
        return severity switch
        {
            "danger" => "badge badge-critical",
            "warning" => "badge badge-low",
            _ => "badge"
        };
    }
}
