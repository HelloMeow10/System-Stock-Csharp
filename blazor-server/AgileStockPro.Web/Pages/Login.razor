@page "/loginnn"
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Authorization
@using AgileStockPro.Web.Auth
@using Microsoft.FluentUI.AspNetCore.Components
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@layout AgileStockPro.Web.Components.LoginLayout

<div style="width:400px;padding:20px;border:1px solid var(--neutral-stroke-rest);border-radius:8px;">
    <h3 style="text-align:center;margin-top:0;">AgileStockPro Login</h3>
    <div style="display:flex;flex-direction:column;gap:12px;">
        <label>Username
            <input style="width:100%;padding:6px;" @bind="Username" />
        </label>
        <label>Password
            <input type="password" style="width:100%;padding:6px;" @bind="Password" />
        </label>
        <button disabled="@IsLoading" @onclick="HandleLogin" style="padding:8px;">Login</button>
        <a href="/recuperar" style="font-size:12px;">¿Olvidaste tu contraseña?</a>
        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div style="color:#b00020;font-size:12px;">@ErrorMessage</div>
        }
    </div>
</div>

@code {
    private string Username { get; set; } = "";
    private string Password { get; set; } = "";
    private string ErrorMessage { get; set; } = "";
    private bool IsLoading { get; set; } = false;

    private async Task HandleLogin()
    {
        IsLoading = true;
        ErrorMessage = "";
        try
        {
            var auth = (CustomAuthenticationStateProvider)AuthStateProvider;
            var success = await auth.LoginAsync(Username, Password);
            if (success)
            {
                Navigation.NavigateTo("/");
            }
            else
            {
                ErrorMessage = "Invalid username or password.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }
}
