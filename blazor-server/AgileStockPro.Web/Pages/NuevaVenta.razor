@page "/ventas/nueva"
@using BusinessLogic.Services
@using Contracts
@using Microsoft.AspNetCore.Authorization
@using AgileStockPro.Web.Models
@attribute [Authorize]
@inject ISalesService SalesService
@inject IClientService ClientService
@inject IProductCatalogService ProductService
@inject IToastService Toast
@inject NavigationManager Nav

<PageTitle>Nueva Venta</PageTitle>

<div class="content" style="padding:20px; max-width:1200px; margin:0 auto;">
    <div class="page-header" style="margin-bottom:20px;">
        <div class="title"><h1>Nueva Venta</h1></div>
            <div class="actions">
            <button class="btn btn-outline" @onclick="GoToVentas">Volver</button>
        </div>
    </div>

    <div class="panel" style="margin-bottom:20px; padding:16px;">
        <h3>Datos del Cliente</h3>
        <div class="form-grid" style="grid-template-columns:1fr 160px; gap:16px; align-items:end;">
            <select class="input" @bind="selectedClientId">
                <option value="">-- Seleccione un cliente --</option>
                @foreach (var c in clients)
                {
                    <option value="@c.Id">@c.Nombre (@c.CuitDni)</option>
                }
            </select>

            <div>
                <button class="btn" @onclick="GoToClientes">Gestionar Clientes</button>
            </div>
        </div>
    </div>

    <div class="panel" style="margin-bottom:20px; padding:16px;">
        <h3>Agregar Productos</h3>
        <div style="display:grid; grid-template-columns:2fr 100px 100px auto; gap:12px; align-items:end;">
            <select class="input" @bind="selectedProductId">
                <option value="">-- Seleccione producto --</option>
                @foreach (var p in products)
                {
                    <option value="@p.Id">@p.Nombre (Stock: @p.StockActual) - @p.Precio.ToString("C2")</option>
                }
            </select>

            <input class="input" type="number" min="1" @bind="quantity" />

            <div></div>

            <button class="btn btn-primary" @onclick="AddToCart">Agregar</button>
        </div>
        @if (!string.IsNullOrEmpty(addProductError))
        {
            <div class="error-text" style="margin-top:10px;">@addProductError</div>
        }
    </div>

    @if (cartItems.Any())
    {
        <div class="panel" style="padding:16px;">
            <h3>Detalle de Venta</h3>
            <div class="data-grid">
                <table>
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unit.</th>
                            <th>Subtotal</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in cartItems)
                        {
                            <tr>
                                <td>@item.ProductName</td>
                                <td>@item.Quantity</td>
                                <td>@item.UnitPrice.ToString("C2")</td>
                                <td>@item.Subtotal.ToString("C2")</td>
                                <td><button class="btn" @onclick="() => RemoveFromCart(item)">Eliminar</button></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div style="margin-top:20px; text-align:right;">
                <h3>Total: @cartItems.Sum(i => i.Subtotal).ToString("C2")</h3>
                <button class="btn btn-primary" @onclick="ConfirmSale" disabled="@isSubmitting">@((isSubmitting) ? "Procesando..." : "Confirmar Venta")</button>
            </div>
        </div>
    }
</div>

@code {
    private List<ClientDto> clients = new();
    private List<ProductDto> products = new();
    private string? selectedClientId;
    private string? selectedProductId;
    private int quantity = 1;
    private string? addProductError;
    private bool isSubmitting;

    private List<CartItem> cartItems = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            clients = (await ClientService.GetAllAsync()).ToList();
            // Fetching first 100 products for now. In a real app, this should be a search.
            var productResponse = await ProductService.GetProductsAsync(null, 1, 100);
            products = productResponse.Items.ToList();
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Error cargando datos: {ex.Message}");
        }
    }

    private void AddToCart()
    {
        addProductError = null;

        if (string.IsNullOrEmpty(selectedProductId))
        {
            addProductError = "Seleccione un producto.";
            return;
        }

        if (quantity <= 0)
        {
            addProductError = "La cantidad debe ser mayor a 0.";
            return;
        }

        int prodId = int.Parse(selectedProductId);
        var product = products.FirstOrDefault(p => p.Id == prodId);
        if (product == null) return;

        // Check local stock (including what's already in cart)
        var inCart = cartItems.FirstOrDefault(i => i.ProductId == prodId);
        int currentQtyInCart = inCart?.Quantity ?? 0;

        if (product.StockActual < (quantity + currentQtyInCart))
        {
            addProductError = $"Stock insuficiente. Disponible: {product.StockActual}. En carrito: {currentQtyInCart}.";
            return;
        }

        if (inCart != null)
        {
            inCart.Quantity += quantity;
        }
        else
        {
            cartItems.Add(new CartItem
            {
                ProductId = product.Id,
                ProductName = product.Nombre,
                Quantity = quantity,
                UnitPrice = product.Precio
            });
        }

        // Reset inputs
        quantity = 1;
        selectedProductId = null; // Optional: keep selected or clear
    }

    private void RemoveFromCart(CartItem item)
    {
        cartItems.Remove(item);
    }

    private async Task ConfirmSale()
    {
        if (string.IsNullOrEmpty(selectedClientId))
        {
            Toast.ShowError("Seleccione un cliente.");
            return;
        }

        if (!cartItems.Any())
        {
            Toast.ShowError("El carrito está vacío.");
            return;
        }

        isSubmitting = true;
        try
        {
            var request = new CreateSaleOrderRequest
            {
                IdCliente = int.Parse(selectedClientId),
                Fecha = DateTime.Now,
                TipoDocumento = "NotaPedido",
                Total = cartItems.Sum(i => i.Subtotal),
                Items = cartItems.Select(i => new SaleOrderDetailRequest
                {
                    IdProducto = i.ProductId,
                    Cantidad = i.Quantity,
                    PrecioUnitario = i.UnitPrice
                }).ToList()
            };

            await SalesService.CreateSaleAsync(request);
            Toast.ShowSuccess("Venta registrada correctamente.");
            Nav.NavigateTo("/ventas");
        }
        catch (Exception ex)
        {
            Toast.ShowError(ex.Message);
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void GoToVentas()
    {
        Nav.NavigateTo("/ventas");
    }

    private void GoToClientes()
    {
        Nav.NavigateTo("/clientes");
    }

    class CartItem
    {
        public int ProductId { get; set; }
        public string ProductName { get; set; } = string.Empty;
        public int Quantity { get; set; }
        public decimal UnitPrice { get; set; }
        public decimal Subtotal => Quantity * UnitPrice;
    }
}
