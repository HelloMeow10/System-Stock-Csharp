@page "/clientes"
@using BusinessLogic.Services
@using Contracts
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IClientService ClientService
@inject IInvoicingService InvoicingService
@inject IDialogService DialogService
@inject AgileStockPro.Web.Services.IAuthService AuthService
@inject IToastService Toast

<AuthGuard>
<PageTitle>Clientes</PageTitle>

<div style="padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Clientes</h1>
        @if (currentUser?.IsAdmin == true)
        {
            <button class="btn btn-primary" @onclick="AddClient">Nuevo Cliente</button>
        }
    </div>

    <input class="input search" placeholder="Buscar por nombre o CUIT..." value="@searchTerm" style="width: 300px; margin-bottom: 20px;" @oninput="@(e => Search(e.Value?.ToString()))" />

    @if (clients == null)
    {
        <div class="helper-small">Cargando...</div>
    }
    else
    {
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Código</th>
                    <th>Nombre</th>
                    <th>Razón Social</th>
                    <th>CUIT/DNI</th>
                    <th>Límite Crédito</th>
                    <th>Descuento %</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var c in clients)
                {
                    <tr>
                        <td>@c.Id</td>
                        <td>@c.Codigo</td>
                        <td>@c.Nombre</td>
                        <td>@c.RazonSocial</td>
                        <td>@c.CuitDni</td>
                        <td>@(c.LimiteCredito.ToString("C2"))</td>
                        <td>@(c.Descuento.ToString("P0"))</td>
                        <td>
                            @if (currentUser?.IsAdmin == true)
                            {
                                <button class="btn" @onclick="() => Edit(c)">Editar</button>
                                <button class="btn" style="margin-left:.5rem;" @onclick="() => Delete(c)">Eliminar</button>
                            }
                            else
                            {
                                <span class="helper-small" style="font-size:12px;">Solo lectura</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

</AuthGuard>

@code {
    private IEnumerable<ClientDto>? clients;
    private IEnumerable<PaymentMethodDto> paymentMethods = new List<PaymentMethodDto>();
    private string searchTerm = "";

    private AgileStockPro.Web.Models.AppUser? currentUser;
    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthService.GetCurrentUserAsync();
        await LoadData();
    }

    private async Task LoadData()
    {
        var t1 = ClientService.GetAllAsync();
        var t2 = InvoicingService.GetPaymentMethodsAsync();
        await Task.WhenAll(t1, t2);
        clients = await t1;
        paymentMethods = await t2;
    }

    private async Task Search(string? term)
    {
        searchTerm = term ?? "";
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            await LoadData();
        }
        else
        {
            clients = await ClientService.SearchAsync(searchTerm);
        }
    }

    

    // Delete with confirmation
    private ClientDto? clientToDelete;
    private bool showConfirmDelete = false;

    private void Delete(ClientDto client)
    {
        clientToDelete = client;
        showConfirmDelete = true;
    }

    private async Task ConfirmDelete()
    {
        if (clientToDelete == null) return;
        try
        {
            await ClientService.DeleteAsync(clientToDelete.Id);
            Toast.ShowSuccess("Cliente eliminado.");
            clientToDelete = null;
            showConfirmDelete = false;
            await LoadData();
        }
        catch (Exception ex)
        {
            Toast.ShowError("Error al eliminar: " + ex.Message);
        }
    }

    private void CancelDelete()
    {
        clientToDelete = null;
        showConfirmDelete = false;
    }

    // Modal / inline form state
    private bool showClientModal = false;
    private CreateClientRequest editingModel = new CreateClientRequest();
    private bool isEditMode = false;
    private string modalTitle = "";

    private void AddClient()
    {
        isEditMode = false;
        editingModel = new CreateClientRequest();
        modalTitle = "Nuevo Cliente";
        showClientModal = true;
    }

    private void Edit(ClientDto client)
    {
        isEditMode = true;
        editingModel = new UpdateClientRequest
        {
            Id = client.Id,
            Codigo = client.Codigo,
            Nombre = client.Nombre,
            RazonSocial = client.RazonSocial,
            CuitDni = client.CuitDni,
            IdFormaPago = client.IdFormaPago,
            LimiteCredito = client.LimiteCredito,
            Descuento = client.Descuento,
            Estado = client.Estado
        };
        modalTitle = "Editar Cliente";
        showClientModal = true;
    }

    private async Task SaveClient()
    {
        try
        {
            if (isEditMode && editingModel is UpdateClientRequest upd)
            {
                await ClientService.UpdateAsync(upd);
                Toast.ShowSuccess("Cliente actualizado.");
            }
            else
            {
                await ClientService.CreateAsync(editingModel);
                Toast.ShowSuccess("Cliente creado.");
            }

            showClientModal = false;
            await LoadData();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error saving client: " + ex.Message);
            Toast.ShowError("Error al guardar: " + ex.Message);
        }
    }

    private void CancelEdit()
    {
        showClientModal = false;
    }
}

@if (showClientModal)
{
    <div class="panel person-modal-panel" style="position:fixed; inset:0; display:grid; place-items:center; background: rgba(0,0,0,0.35); z-index:50;">
        <div class="panel" style="width:720px; max-width:95%;">
            <div class="panel-header">
                <h3>@modalTitle</h3>
            </div>
            <div class="panel-body">
                <div class="form-grid">
                    <label>Código</label>
                    <input class="input" @bind="editingModel.Codigo" />

                    <label>Nombre</label>
                    <input class="input" @bind="editingModel.Nombre" />

                    <label>Razón Social</label>
                    <input class="input" @bind="editingModel.RazonSocial" />

                    <label>CUIT/DNI</label>
                    <input class="input" @bind="editingModel.CuitDni" />

                    <label>Forma de Pago</label>
                    <select class="select" @bind="editingModel.IdFormaPago">
                        <option value="0">Seleccione...</option>
                        @foreach(var pm in paymentMethods)
                        {
                            <option value="@pm.Id">@pm.Nombre</option>
                        }
                    </select>

                    <label>Límite Crédito</label>
                    <input class="input" type="number" step="0.01" @bind="editingModel.LimiteCredito" />

                    <label>Descuento %</label>
                    <input class="input" type="number" step="0.01" @bind="editingModel.Descuento" />
                </div>
                <div class="modal-actions" style="margin-top:1rem;">
                    <button class="btn" @onclick="CancelEdit">Cancelar</button>
                    <button class="btn btn-primary" @onclick="SaveClient" style="margin-left:.5rem;">Guardar</button>
                </div>
            </div>
        </div>
    </div>
}

@if (showConfirmDelete && clientToDelete != null)
{
    <div class="panel person-modal-panel" style="position:fixed; inset:0; display:grid; place-items:center; background: rgba(0,0,0,0.35); z-index:50;">
        <div class="panel" style="width:420px; max-width:95%;">
            <div class="panel-header">
                <h3>Confirmar eliminación</h3>
            </div>
            <div class="panel-body">
                <p>¿Seguro que deseas eliminar al cliente <strong>@clientToDelete.Nombre</strong> (Código: @clientToDelete.Codigo)? Esta acción no se puede deshacer.</p>
                <div class="modal-actions" style="margin-top:1rem;">
                    <button class="btn" @onclick="CancelDelete">Cancelar</button>
                    <button class="btn btn-primary" @onclick="ConfirmDelete" style="margin-left:.5rem;">Eliminar</button>
                </div>
            </div>
        </div>
    </div>
}
