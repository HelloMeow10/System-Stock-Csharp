@page "/clientes"
@using BusinessLogic.Services
@using Contracts
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IClientService ClientService
@inject IDialogService DialogService
@inject AgileStockPro.Web.Services.IAuthService AuthService

<PageTitle>Clientes</PageTitle>

<div style="padding: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Clientes</h1>
        @if (currentUser?.IsAdmin == true)
        {
            <FluentButton Appearance="Appearance.Accent" OnClick="@AddClient">Nuevo Cliente</FluentButton>
        }
    </div>

    <FluentTextField @bind-Value="searchTerm" Placeholder="Buscar por nombre o CUIT..." Style="width: 300px; margin-bottom: 20px;" @oninput="@(e => Search(e.Value?.ToString()))" />

    @if (clients == null)
    {
        <FluentProgressRing />
    }
    else
    {
        <FluentDataGrid Items="@clients.AsQueryable()" ResizableColumns="true" GridTemplateColumns="0.5fr 1fr 1fr 1fr 1fr 0.5fr 0.5fr 1fr">
            <PropertyColumn Property="@(p => p.Id)" Sortable="true" />
            <PropertyColumn Property="@(p => p.Codigo)" Sortable="true" Title="Código" />
            <PropertyColumn Property="@(p => p.Nombre)" Sortable="true" />
            <PropertyColumn Property="@(p => p.RazonSocial)" Sortable="true" Title="Razón Social" />
            <PropertyColumn Property="@(p => p.CuitDni)" Sortable="true" Title="CUIT/DNI" />
            <PropertyColumn Property="@(p => p.LimiteCredito)" Sortable="true" Title="Límite Crédito" />
            <PropertyColumn Property="@(p => p.Descuento)" Sortable="true" Title="Descuento %" />
            <TemplateColumn Title="Acciones">
                @if (currentUser?.IsAdmin == true)
                {
                    <FluentButton IconEnd="@(new Icons.Regular.Size16.Edit())" OnClick="@(() => Edit(context))" Appearance="Appearance.Lightweight" />
                    <FluentButton IconEnd="@(new Icons.Regular.Size16.Delete())" OnClick="@(() => Delete(context))" Appearance="Appearance.Lightweight" />
                }
                else
                {
                    <span class="muted" style="font-size:12px;">Solo lectura</span>
                }
            </TemplateColumn>
        </FluentDataGrid>
    }
</div>

@code {
    private IEnumerable<ClientDto>? clients;
    private string searchTerm = "";

    private AgileStockPro.Web.Models.AppUser? currentUser;
    protected override async Task OnInitializedAsync()
    {
        currentUser = await AuthService.GetCurrentUserAsync();
        await LoadData();
    }

    private async Task LoadData()
    {
        clients = await ClientService.GetAllAsync();
    }

    private async Task Search(string? term)
    {
        searchTerm = term ?? "";
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            await LoadData();
        }
        else
        {
            clients = await ClientService.SearchAsync(searchTerm);
        }
    }

    private async Task AddClient()
    {
        // TODO: Implement Dialog
    }

    private async Task Edit(ClientDto client)
    {
        // TODO: Implement Dialog
    }

    private async Task Delete(ClientDto client)
    {
        await ClientService.DeleteAsync(client.Id);
        await LoadData();
    }
}
