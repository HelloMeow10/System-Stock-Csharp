@page "/usuarios/alta"
@inject AgileStockPro.Web.Services.IUserStore UserStore
@inject AgileStockPro.Web.Services.Api.ISecurityQuestionsAdminService QuestionsService
@inject AgileStockPro.Web.Services.IAuthService Auth
@inject IToastService Toast
@using AgileStockPro.Web.Components
@using AgileStockPro.Web.Services.Api

<AuthGuard RequireAdmin="true">
    <PageHeader Title="Alta de usuario" />

    @if (policy is null)
    {
        <p>Cargando política…</p>
    }
    else if (questions is null)
    {
        <p>Cargando preguntas…</p>
    }
    else
    {
        <div class="panel" style="max-width:800px;">
            <h3>Datos básicos</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:.5rem;">
                <label>Username</label>
                <input class="input" @bind="username" />
                <label>Persona ID</label>
                <input class="input" @bind="personaId" />
                <label>Rol</label>
                <select class="input" @bind="rol">
                    <option value="Usuario">Usuario</option>
                    <option value="Admin">Admin</option>
                </select>
            </div>
            <div style="margin-top:1rem;">
                <button class="btn btn-primary" @onclick="GeneratePassword">Generar contraseña</button>
                @if (!string.IsNullOrWhiteSpace(generatedPassword))
                {
                    <div class="muted" style="margin-top:.5rem;">Temporal: <code>@generatedPassword</code></div>
                }
            </div>
            <hr />
            <h3>Preguntas de seguridad (@policy.QuestionsCount requeridas)</h3>
            <p>Seleccioná exactamente @policy.QuestionsCount preguntas y completá sus respuestas.</p>
            <div>
                @for (int i = 0; i < policy.QuestionsCount; i++)
                {
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.5rem; margin-bottom:.5rem;">
                        <select class="input" @bind="selectedIds[i]">
                            <option value="">-- seleccionar --</option>
                            @foreach (var q in questions)
                            {
                                <option value="@q.IdPregunta">@q.Pregunta</option>
                            }
                        </select>
                        <input placeholder="Respuesta" class="input" @bind="answers[i]" />
                    </div>
                }
            </div>
            <div style="margin-top:1rem; display:flex; gap:.5rem;">
                <button class="btn btn-primary" @onclick="CreateUser" disabled="@creating">Crear usuario</button>
                @if (creating) { <span>Procesando…</span> }
            </div>
            @if (!string.IsNullOrWhiteSpace(info))
            {
                <div class="alert alert-info" style="margin-top:1rem;">@info</div>
            }
            @if (!string.IsNullOrWhiteSpace(error))
            {
                <div class="alert alert-danger" style="margin-top:1rem;">@error</div>
            }
        </div>
    }
</AuthGuard>

@code {
    private AgileStockPro.Web.Models.SecurityPolicy? policy;
    private List<PreguntaSeguridadDto>? questions;
    private string? username;
    private string? personaId;
    private string rol = "Usuario";
    private string? generatedPassword;
    private bool creating;
    private string? error; private string? info;
    private List<string?> answers = new();
    private List<string?> selectedIds = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            policy = await UserStore.GetPolicyAsync();
            questions = (await QuestionsService.GetAllAsync()).ToList();
            InitArrays();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private void InitArrays()
    {
        if (policy == null) return;
        answers = Enumerable.Range(0, policy.QuestionsCount).Select(_ => string.Empty).ToList();
        selectedIds = Enumerable.Range(0, policy.QuestionsCount).Select(_ => string.Empty).ToList();
    }

    private void GeneratePassword()
    {
        if (policy == null) return;
        generatedPassword = Generate(policy);
    }

    private static string Generate(AgileStockPro.Web.Models.SecurityPolicy pol)
    {
        var rnd = new Random();
        string upper = "ABCDEFGHJKLMNPQRSTUVWXYZ";
        string lower = "abcdefghijkmnopqrstuvwxyz";
        string digits = "23456789";
        string special = "@$!%*?&";
        List<char> chars = new();
        if (pol.RequireUpperLower) { chars.Add(upper[rnd.Next(upper.Length)]); chars.Add(lower[rnd.Next(lower.Length)]); }
        if (pol.RequireNumber) chars.Add(digits[rnd.Next(digits.Length)]);
        if (pol.RequireSpecial) chars.Add(special[rnd.Next(special.Length)]);
        string pool = upper + lower + digits + special;
        while (chars.Count < pol.MinLength) chars.Add(pool[rnd.Next(pool.Length)]);
        return new string(chars.OrderBy(_ => rnd.Next()).ToArray());
    }

    private async Task CreateUser()
    {
        error = info = null;
        if (policy == null || questions == null) { error = "Contexto incompleto"; return; }
        if (string.IsNullOrWhiteSpace(username) || string.IsNullOrWhiteSpace(personaId)) { error = "Username y Persona ID requeridos"; return; }
        if (generatedPassword == null) { error = "Generá la contraseña temporal"; return; }
        if (selectedIds.Any(s => string.IsNullOrWhiteSpace(s))) { error = "Seleccioná todas las preguntas"; return; }
        if (answers.Any(a => string.IsNullOrWhiteSpace(a))) { error = "Completá todas las respuestas"; return; }
        creating = true;
        try
        {
            var user = new AgileStockPro.Web.Models.AppUser
            {
                Username = username!,
                BackendIdPersona = int.TryParse(personaId, out var pid) ? pid : null,
                IsAdmin = string.Equals(rol, "Admin", StringComparison.OrdinalIgnoreCase),
                TempPassword = generatedPassword,
                MustChangePassword = true
            };
            await UserStore.SaveAsync(user);
            // Guardar respuestas
            var dict = new Dictionary<int, string>();
            for (int i = 0; i < selectedIds.Count; i++)
            {
                if (int.TryParse(selectedIds[i], out var idp))
                {
                    dict[idp] = answers[i] ?? string.Empty;
                }
            }
            // POST respuestas
            await SaveAnswersAsync(user.Username, dict);
            info = $"Usuario creado. Contraseña temporal: {generatedPassword}";
            Toast.ShowSuccess("Usuario creado");
            InitArrays();
            username = personaId = generatedPassword = null; rol = "Usuario";
        }
        catch (Exception ex)
        {
            error = ex.Message;
            Toast.ShowError(error);
        }
        creating = false;
    }

    private async Task SaveAnswersAsync(string userName, Dictionary<int,string> answersDict)
    {
        try
        {
            var ok = await QuestionsService.SaveAnswersAsync(userName, answersDict);
            if (!ok)
            {
                Toast.ShowWarning("No se guardaron las respuestas de seguridad");
            }
        }
        catch (Exception ex)
        {
            Toast.ShowError($"Error guardando respuestas: {ex.Message}");
        }
    }
}
